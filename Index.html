<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Las Huellitas de mi Vida</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Fredoka -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos base y de dise√±o inspirados en la imagen */
        body {
            background: linear-gradient(135deg, #2b1634, #1f143a);
            font-family: 'Fredoka', sans-serif;
            scroll-behavior: smooth;
        }
        .main-button {
            background: linear-gradient(90deg, #8E2DE2, #4A00E0);
            box-shadow: 0 0 15px rgba(142, 45, 226, 0.6);
            transition: all 0.3s ease-in-out;
        }
        .main-button:hover:not(:disabled) {
            box-shadow: 0 0 30px rgba(142, 45, 226, 1);
            transform: translateY(-3px) scale(1.05);
        }
        .main-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .secondary-button {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease-in-out;
        }
        .secondary-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: #00FFFF;
        }
        .category-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .category-card:before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 0.75rem; /* rounded-xl */
            border: 2px solid transparent;
            background: linear-gradient(45deg, #00FFFF, #FF00FF) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: destination-out;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .category-card:hover:before {
            opacity: 1;
        }
        .category-card:hover {
            transform: translateY(-5px);
        }
        .form-input, .form-textarea, .form-select {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #FF00FF;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
            background-color: rgba(0, 0, 0, 0.3);
        }
        .backdrop-blur-md {
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }
        /* Animaci√≥n para aparici√≥n de secciones */
        .section-fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Huellas decorativas de fondo */
        .paw-bg-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .paw-bg-container img {
            position: absolute;
            opacity: 0.2; /* Ajustado seg√∫n requerimiento */
            filter: brightness(1.2);
        }
        /* Estilos para la nueva galer√≠a de miniaturas */
        .thumbnail-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }
        .thumbnail-image.active {
            border-color: #00FFFF; /* Color de acento cian */
        }
    </style>
</head>
<body class="text-[#F0F0F0] antialiased overflow-x-hidden">

    <!-- Mensaje de Error de Configuraci√≥n de Firebase -->
    <div id="firebase-error-overlay" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center text-center p-4">
        <div class="bg-red-900 border border-red-500 p-8 rounded-lg max-w-lg">
            <h2 class="text-2xl font-bold text-yellow-300 mb-4">¬°Error de Configuraci√≥n!</h2>
            <p class="text-white">Parece que la aplicaci√≥n no est√° conectada a Firebase. Por favor, sigue estos pasos:</p>
            <ol class="text-left text-white list-decimal list-inside my-4 space-y-2">
                <li>Ve a tu proyecto en la <a href="https://console.firebase.google.com/" target="_blank" class="underline text-cyan-400">Consola de Firebase</a>.</li>
                <li>Haz clic en el √≠cono de engranaje (‚öôÔ∏è) y ve a "Configuraci√≥n del proyecto".</li>
                <li>En la pesta√±a "General", en la secci√≥n "Tus apps", copia el objeto <strong>firebaseConfig</strong>.</li>
                <li>Pega ese objeto en el archivo <strong>index.html</strong>, reemplazando los valores de ejemplo.</li>
            </ol>
            <p class="text-gray-300 text-sm">El c√≥digo no funcionar√° hasta que se complete este paso.</p>
        </div>
    </div>

    <!-- Huellas Decorativas de Fondo -->
    <div class="paw-bg-container">
        <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella" style="width: 15%; top: 10%; left: 5%; transform: rotate(-20deg);">
        <img src="https://i.ibb.co/mFSBSN3X/huellas-2.png" alt="huella" style="width: 10%; top: 20%; right: 10%; transform: rotate(15deg);">
        <img src="https://i.ibb.co/vx7Wb795/huellas.png" alt="huella" style="width: 8%; bottom: 15%; left: 20%; transform: rotate(30deg);">
        <img src="https://i.ibb.co/ttbd6wP/huellas-4.png" alt="huella" style="width: 12%; bottom: 5%; right: 15%; transform: rotate(-10deg);">
        <img src="https://i.ibb.co/MDZYf540/huellas-6.png" alt="huella" style="width: 9%; top: 55%; left: 10%; transform: rotate(5deg);">
        <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella" style="width: 7%; top: 70%; right: 5%; transform: rotate(25deg);">
    </div>

    <!-- Header Fijo -->
    <header class="fixed top-0 left-0 right-0 z-50">
        <nav class="container mx-auto px-6 py-4 bg-black/20 backdrop-blur-md flex items-center justify-center md:justify-start">
            <img id="header-logo" src="https://i.ibb.co/4R3Rx0Vx/Gemini_Generated_Image-b8hqcvb8hqcvb8hq.png" alt="Logo" class="h-10 w-10 mr-3 rounded-full">
            <h1 class="text-xl font-bold tracking-wider">Las Huellitas de mi Vida</h1>
        </nav>
    </header>

    <!-- Contenedor Principal de la App -->
    <main id="app-container" class="container mx-auto px-6 pt-28 pb-12 min-h-screen flex flex-col justify-center">

        <!-- PASO 1: P√°gina Principal (Hero) -->
        <section id="home-section" class="text-center section-fade-in">
            <h2 class="text-4xl md:text-5xl font-bold mt-8 mb-4" style="font-weight: 700;">Cada huella cuenta una historia&nbsp;üêæ</h2>
            <p class="text-lg text-gray-300 mb-8 max-w-2xl mx-auto">Transformemos tus recuerdos m√°s preciados en una obra de arte inolvidable.</p>
            <div class="my-8 flex justify-center">
                <img id="hero-image" src="https://i.ibb.co/0jRX3VX2/PORTADA-HUELLitas-3.png" alt="Collage de mascotas" class="max-w-md w-full rounded-2xl shadow-2xl">
            </div>
            <button id="start-project-btn" class="main-button text-white font-bold py-3 px-8 rounded-full text-lg">
                Elige tu Proyecto&nbsp;üêæ
            </button>

            <!-- SECCI√ìN DE GALER√çA -->
            <div id="gallery-section" class="mt-24">
                 <h2 class="text-4xl font-bold mt-8 mb-8" style="font-weight: 700;">Nuestras Obras Recientes&nbsp;üêæ</h2>
                 <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-5xl mx-auto">
                     <!-- Las im√°genes de la galer√≠a se cargar√°n aqu√≠ -->
                 </div>
            </div>
        </section>

        <!-- PASO 2: Selecci√≥n de Categor√≠a -->
        <section id="category-section" class="hidden text-center section-fade-in">
            <h2 class="text-4xl font-bold mt-8 mb-8" style="font-weight: 700;">¬øQu√© historia vamos a contar hoy?&nbsp;üêæ</h2>
            <div id="category-grid" class="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                <!-- Las categor√≠as se cargar√°n aqu√≠ desde Firebase -->
            </div>
        </section>

        <!-- PASO 3: Formulario Datos de la Mascota -->
        <section id="pet-info-section" class="hidden section-fade-in">
             <div class="max-w-lg mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                 <!-- Contenedor para la imagen del producto seleccionado -->
                 <div class="flex justify-center mb-4">
                    <img id="product-image-preview" src="" alt="Producto seleccionado" class="rounded-lg max-h-40 shadow-lg">
                 </div>
                 <!-- NUEVO: Contenedor para las miniaturas -->
                 <div id="thumbnail-container" class="flex justify-center gap-2 mb-6">
                     <!-- Las miniaturas se generar√°n aqu√≠ con JavaScript -->
                 </div>
                 <h2 id="pet-info-title" class="text-3xl font-bold text-center mb-6" style="font-weight: 700;">Datos de tu Mascota</h2>
                 <div class="space-y-6">
                     <div>
                         <label for="pet-name" class="block text-sm font-medium text-[#00FFFF] mb-1">Nombre de tu mascota</label>
                         <input type="text" id="pet-name" class="form-input w-full p-3 rounded-lg text-white" placeholder="Ej: Tat√°n" autocomplete="off">
                     </div>
                     <div>
                         <label for="pet-age" class="block text-sm font-medium text-[#00FFFF] mb-1">Edad (en a√±os humanos)</label>
                         <input type="number" id="pet-age" class="form-input w-full p-3 rounded-lg text-white" placeholder="Ej: 2" autocomplete="off">
                     </div>
                     <div class="flex justify-between items-center pt-4">
                         <button id="back-to-category" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                         <button id="to-upload-section" class="main-button text-white font-bold py-2 px-6 rounded-full">Continuar</button>
                     </div>
                 </div>
             </div>
        </section>

        <!-- PASO 4: Formulario Carga de Archivos -->
        <section id="upload-section" class="hidden section-fade-in">
             <div class="max-w-lg mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                 <h2 class="text-3xl font-bold text-center mb-6" style="font-weight: 700;">Ahora, sube tus recuerdos&nbsp;üêæ</h2>
                
                 <div id="video-choice-container" class="text-center">
                     <p class="text-[#00FFFF] mb-4">¬øIncluir√°s videos en tu homenaje?</p>
                     <div class="flex justify-center gap-4">
                         <button id="has-video-btn" class="main-button font-bold py-3 px-6 rounded-full">S√≠, tengo videos&nbsp;üé¨</button>
                         <button id="no-video-btn" class="secondary-button font-bold py-3 px-6 rounded-full">No, usar√© solo fotos&nbsp;üñºÔ∏è</button>
                     </div>
                 </div>

                 <div id="file-inputs-container" class="hidden space-y-6 mt-6">
                     <div id="photos-and-video-upload" class="hidden space-y-4">
                         <div>
                             <label for="photo-input-multi" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga hasta 10 fotos</label>
                             <input type="file" id="photo-input-multi" multiple accept="image/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                         </div>
                         <div>
                             <label for="video-input-multi" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga tus videos</label>
                             <input type="file" id="video-input-multi" multiple accept="video/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                         </div>
                     </div>
                      <div id="photos-only-upload" class="hidden">
                         <label for="photo-input-only" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga hasta 20 fotos</label>
                         <p class="text-xs text-gray-400 mb-2">Con ellas crearemos un video emotivo para el QR de tu obra.</p>
                         <input type="file" id="photo-input-only" multiple accept="image/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                     </div>

                     <div>
                         <label for="short-text" class="block text-sm font-medium text-[#00FFFF] mb-1">Texto Corto (Opcional)</label>
                         <textarea id="short-text" rows="3" class="form-textarea w-full p-3 rounded-lg text-white" placeholder="Una frase o fecha especial..."></textarea>
                         <p id="short-text-counter" class="text-xs text-right text-gray-400 mt-1">0 / 150</p>
                     </div>
                     <div>
                         <label for="long-text" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Historia (Opcional)</label>
                         <textarea id="long-text" rows="5" class="form-textarea w-full p-3 rounded-lg text-white" placeholder="Cu√©ntanos un poco sobre tu amiguito, sus gustos, alguna an√©ctoda..."></textarea>
                         <p id="long-text-counter" class="text-xs text-right text-gray-400 mt-1">0 / 400</p>
                     </div>
                     <div class="flex items-center space-x-3 p-3 bg-yellow-900/20 rounded-lg">
                         <input id="surprise-me-checkbox" type="checkbox" class="h-5 w-5 rounded bg-transparent border-yellow-400 text-yellow-500 focus:ring-yellow-600">
                         <label for="surprise-me-checkbox" class="font-bold text-yellow-300">¬°Sorpr√©ndeme!&nbsp;üêæ</label>
                     </div>
                      <p id="surprise-me-text" class="text-xs text-yellow-400 hidden">Al marcar esta opci√≥n, con mucho respeto, empat√≠a y amor, buscaremos el texto adecuado para tu obra.</p>

                     <div class="flex justify-between items-center pt-4">
                         <button id="back-to-pet-info" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                         <button id="to-summary-section" class="main-button text-white font-bold py-2 px-6 rounded-full">Continuar al Resumen</button>
                     </div>
                 </div>
             </div>
        </section>

        <!-- PASO 5: Resumen y Despacho -->
        <section id="summary-section" class="hidden section-fade-in">
            <div class="max-w-xl mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                <h2 class="text-3xl font-bold text-center mb-6" style="font-weight: 700;">Revisa tu Pedido</h2>
                <div id="summary-content" class="space-y-4 mb-8 p-4 bg-white/5 rounded-lg">
                    <!-- El resumen se inyectar√° aqu√≠ con JS -->
                </div>
                <h3 class="text-2xl font-bold text-center mb-4" style="font-weight: 700;">Informaci√≥n de Despacho</h3>
                <div id="shipping-form" class="space-y-4">
                    <!-- NUEVOS CAMPOS A√ëADIDOS AQUI -->
                    <div>
                        <label for="client-name-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Nombre Completo</label>
                        <input type="text" id="client-name-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="Para el registro del pedido">
                    </div>
                    <div>
                        <label for="client-phone-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Tel√©fono (WhatsApp)</label>
                        <input type="tel" id="client-phone-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="+56 9 1234 5678">
                    </div>
                    <!-- FIN DE NUEVOS CAMPOS -->
                    <div>
                        <label for="region-select" class="block text-sm font-medium text-[#00FFFF] mb-1">Regi√≥n</label>
                        <select id="region-select" class="form-select w-full p-3 rounded-lg text-white"></select>
                    </div>
                    <div>
                        <label for="comuna-select" class="block text-sm font-medium text-[#00FFFF] mb-1">Comuna</label>
                        <select id="comuna-select" class="form-select w-full p-3 rounded-lg text-white"></select>
                    </div>
                    <div>
                        <label for="address-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Direcci√≥n</label>
                        <input type="text" id="address-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="Calle, n√∫mero, depto/casa">
                    </div>
                </div>
                 <div class="flex justify-between items-center pt-6">
                    <button id="back-to-upload" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                    <button id="to-payment-section" class="main-button text-white font-bold py-2 px-6 rounded-full">Continuar al Pago</button>
                </div>
            </div>
        </section>

        <!-- PASO 6: Pago -->
        <section id="payment-section" class="hidden section-fade-in">
            <div class="max-w-xl mx-auto bg-black/20 p-8 rounded-xl border border-white/10 text-center">
                <h2 class="text-3xl font-bold mb-4" style="font-weight: 700;">¬°√öltimo paso! Realiza tu pago</h2>
                <p class="text-gray-300 mb-6">Elige tu m√©todo preferido. Una vez realizado, env√≠anos el comprobante por WhatsApp.</p>
                <div id="payment-details" class="grid md:grid-cols-2 gap-8 items-center">
                    <div class="flex flex-col items-center">
                        <h3 class="text-xl font-bold mb-2 text-[#00FFFF]">Paga con QR Mercado Pago</h3>
                        <div id="qr-code-container" class="bg-white p-2 rounded-lg h-48 w-48 flex items-center justify-center">
                            <img id="qr-code-img" src="" alt="C√≥digo QR de Mercado Pago" class="h-full w-full object-contain">
                        </div>
                    </div>
                    <div class="text-left bg-white/5 p-4 rounded-lg">
                        <h3 class="text-xl font-bold mb-3 text-[#00FFFF]">Datos para Transferencia</h3>
                        <p class="text-sm"><strong>Banco:</strong> [Tu Banco]</p>
                        <p class="text-sm"><strong>Tipo de Cuenta:</strong> [Tu Tipo de Cuenta]</p>
                        <p class="text-sm"><strong>N¬∫ de Cuenta:</strong> [Tu N√∫mero de Cuenta]</p>
                        <p class="text-sm"><strong>Nombre:</strong> [Tu Nombre Completo]</p>
                        <p class="text-sm"><strong>RUT:</strong> [Tu RUT]</p>
                        <p class="text-sm"><strong>Email:</strong> [Tu Email]</p>
                    </div>
                </div>
                <div class="mt-8">
                    <p class="text-2xl font-bold">MONTO TOTAL: <span id="total-amount" class="text-green-400"></span></p>
                </div>
                <div class="mt-8">
                    <!-- BOT√ìN CAMBIADO DE <a> a <button> -->
                    <button id="whatsapp-btn" class="main-button inline-flex items-center justify-center text-white font-bold py-3 px-8 rounded-full text-lg w-full md:w-auto">
                        <span id="whatsapp-btn-text">Enviar Comprobante por WhatsApp&nbsp;‚úîÔ∏è</span>
                        <svg id="whatsapp-btn-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
                 <div class="mt-6">
                    <button id="back-to-summary" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                </div>
            </div>
        </section>

    </main>

    <!-- Notificaci√≥n Toast -->
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-red-500 text-white py-3 px-6 rounded-full shadow-lg text-center z-[100] opacity-0 transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Importa las funciones que necesitas de los SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-storage.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDR42aJIpDkXL5T2vgj-J2ceZFVZCqzCms",
            authDomain: "las-huellitas-de-mi-vida.firebaseapp.com",
            projectId: "las-huellitas-de-mi-vida",
            storageBucket: "las-huellitas-de-mi-vida.appspot.com",
            messagingSenderId: "1095265611249",
            appId: "1:1095265611249:web:09930aaef56d0736bea850",
            measurementId: "G-0QB83X7TBC"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const db = getFirestore(app);

        // --- L√ìGICA DE LA APLICACI√ìN ---
        
        const orderState = {
            category: '',
            basePrice: 0,
            imageUrls: [], 
            petName: '',
            petAge: '',
            clientName: '',
            clientPhone: '',
            hasVideo: null,
            shortText: '',
            longText: '',
            surpriseMe: false,
            shipping: {
                region: '',
                comuna: '',
                address: '',
                cost: 0,
            }
        };
        
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx5Rv_MV-2bd8rxP9ly6Tju9CIUGXjpE8aPKYTs8lSgEd_y0mA191L1OLmnUC_6lCz2/exec';

        const sections = document.querySelectorAll('main > section');
        
        function showSection(sectionId) {
            sections.forEach(section => section.classList.add('hidden'));
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.remove('hidden');
                window.scrollTo(0, 0);
            }
        }

        function showNotification(message, isError = true) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            toast.classList.remove('bg-red-500', 'bg-green-500');
            toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

            void toast.offsetWidth; 

            toast.classList.remove('opacity-0');

            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }
        
        function renderProductGallery(urls) {
            const previewImage = document.getElementById('product-image-preview');
            const thumbnailContainer = document.getElementById('thumbnail-container');
            thumbnailContainer.innerHTML = ''; 

            if (!urls || urls.length === 0) {
                previewImage.src = 'https://placehold.co/400x300/333/FFF?text=Sin+Imagen';
                return;
            }

            previewImage.src = urls[0];

            if (urls.length > 1) {
                urls.forEach((url, index) => {
                    const thumb = document.createElement('img');
                    thumb.src = url;
                    thumb.classList.add('thumbnail-image');
                    if (index === 0) {
                        thumb.classList.add('active');
                    }

                    thumb.addEventListener('click', () => {
                        previewImage.src = url;
                        document.querySelectorAll('.thumbnail-image').forEach(t => t.classList.remove('active'));
                        thumb.classList.add('active');
                    });

                    thumbnailContainer.appendChild(thumb);
                });
            }
        }

        // --- FUNCI√ìN MEJORADA Y M√ÅS ROBUSTA PARA OBTENER IM√ÅGENES ---
        function getImageUrlsFromCategory(category) {
            // 1. Busca un array (la opci√≥n preferida) con varias combinaciones de nombres
            if (category.imageUrls && Array.isArray(category.imageUrls) && category.imageUrls.length > 0) {
                return category.imageUrls;
            }
            if (category.ImageUrls && Array.isArray(category.ImageUrls) && category.ImageUrls.length > 0) {
                return category.ImageUrls;
            }
            if (category.images && Array.isArray(category.images) && category.images.length > 0) {
                return category.images;
            }

            // 2. Si no encuentra un array, busca una sola imagen (string) y la convierte en array
            if (category.imageUrl && typeof category.imageUrl === 'string') {
                return [category.imageUrl]; // Devuelve como un array de un solo elemento
            }
            if (category.ImageUrl && typeof category.ImageUrl === 'string') {
                return [category.ImageUrl];
            }
            if (category.image && typeof category.image === 'string') {
                return [category.image];
            }

            // 3. Si no encuentra absolutamente nada, devuelve un array vac√≠o
            return [];
        }


        async function loadCategoriesFromFirestore() {
            const grid = document.getElementById('category-grid');
            grid.innerHTML = '<p class="text-center col-span-3">Cargando proyectos...</p>';
            try {
                const querySnapshot = await getDocs(collection(db, "categories"));
                grid.innerHTML = '';
                if (querySnapshot.empty) {
                     grid.innerHTML = '<p class="text-yellow-400 text-center col-span-3">No hay proyectos disponibles.</p>';
                     return;
                }
                querySnapshot.forEach((doc) => {
                    const category = doc.data();
                    // Usamos la nueva funci√≥n robusta para obtener las URLs
                    const imageUrls = getImageUrlsFromCategory(category); 

                    const cardHTML = `
                        <div class="category-card rounded-xl cursor-pointer flex flex-col text-center" 
                             data-category="${category.name}" 
                             data-price="${category.price}" 
                             data-image-urls='${JSON.stringify(imageUrls)}'>
                            <div class="p-6 flex flex-col flex-grow items-center">
                                <div class="text-6xl mb-4">${category.icon || 'üêæ'}</div>
                                <h3 class="text-xl font-bold mb-1" style="font-weight: 700;">${category.name}</h3>
                                <p class="text-gray-400 text-xs mb-2">${category.size}</p>
                                <p class="text-gray-300 text-sm flex-grow mb-4">${category.description}</p>
                                <p class="text-2xl font-bold mt-auto text-green-400">$${(category.price || 0).toLocaleString('es-CL')}</p>
                            </div>
                        </div>`;
                    grid.innerHTML += cardHTML;
                });
                
                document.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', () => {
                        try {
                            orderState.category = card.dataset.category;
                            orderState.basePrice = parseInt(card.dataset.price);
                            // Se parsea el string JSON del atributo data para obtener el array
                            orderState.imageUrls = JSON.parse(card.dataset.imageUrls); 

                            renderProductGallery(orderState.imageUrls); 

                            document.getElementById('pet-info-title').textContent = `Proyecto: ${orderState.category}`;
                            showSection('pet-info-section');
                        } catch (e) {
                            console.error("Error al procesar la categor√≠a:", e);
                            showNotification("No se pudo cargar el producto. Int√©ntalo de nuevo.");
                        }
                    });
                });

            } catch (error) {
                console.error("Error cargando categor√≠as: ", error);
                const errorBox = document.createElement('div');
                errorBox.className = "text-red-500 text-center col-span-3 p-4 rounded-lg bg-red-900/50";
                errorBox.innerHTML = `<strong class="font-bold">Error de Permisos</strong><br>
                    <p>No se pudieron cargar los proyectos. Para solucionarlo, ve a tu¬†
                    <a href="https://console.firebase.google.com/" target="_blank" class="underline text-cyan-300">consola de Firebase</a>,¬†
                    entra a <strong>Firestore Database</strong>, ve a la pesta√±a <strong>Reglas</strong> y¬†
                    aseg√∫rate de que est√© configurada para permitir la lectura.</p>`;
                grid.innerHTML = '';
                grid.appendChild(errorBox);
            }
        }

        async function loadGalleryImages() {
            const grid = document.getElementById('gallery-grid');
            try {
                const querySnapshot = await getDocs(collection(db, "gallery"));
                if (querySnapshot.empty) {
                    grid.innerHTML = '<p class="text-yellow-400 text-center col-span-full">A√∫n no hay im√°genes en la galer√≠a.</p>';
                    return;
                }
                grid.innerHTML = ''; 
                querySnapshot.forEach((doc) => {
                    const imageData = doc.data();
                    const imgHTML = `
                        <div class="rounded-lg overflow-hidden shadow-lg aspect-square">
                            <img src="${imageData.imageUrl}" alt="Obra de arte para mascota" class="w-full h-full object-cover cursor-pointer hover:scale-110 transition-transform duration-300">
                        </div>`;
                    grid.innerHTML += imgHTML;
                });
            } catch (error) {
                console.error("Error cargando galer√≠a: ", error);
                grid.innerHTML = `<p class="text-red-500 text-center col-span-full">No se pudo cargar la galer√≠a.</p>`;
            }
        }
        
        async function getFirebaseImageUrl(imageName) {
            const imageRef = ref(storage, imageName);
            try {
                return await getDownloadURL(imageRef);
            } catch (error) {
                console.error(`No se pudo obtener la URL para ${imageName}:`, error);
                return 'https://placehold.co/200x200/333/FFF?text=Error_QR';
            }
        }
        
        async function sendDataToGoogleSheet() {
            const formData = new FormData();
            
            formData.append('Categoria', orderState.category);
            formData.append('Nombre Mascota', orderState.petName);
            formData.append('Edad Mascota', orderState.petAge);
            formData.append('Nombre Cliente', orderState.clientName);
            formData.append('Direcci√≥n', orderState.shipping.address);
            formData.append('Comuna/Ciudad', orderState.shipping.comuna);
            formData.append('Telefono', orderState.clientPhone);
            formData.append('Costo Envio', orderState.shipping.cost);
            formData.append('Total Pagado', orderState.basePrice + orderState.shipping.cost);
            
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: formData,
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {

            const locations = {
                "O'Higgins": ["Rancagua", "Machal√≠", "Graneros", "Olivar", "Do√±ihue", "Requ√≠noa", "Codegua", "Mostazal", "Coinco", "Coltauco", "Rengo", "San Fernando", "Pichilemu"],
                "Metropolitana de Santiago": ["Santiago", "Providencia", "Las Condes", "Maip√∫", "Puente Alto"],
                "Valpara√≠so": ["Valpara√≠so", "Vi√±a del Mar", "Quilpu√©", "Conc√≥n"],
                "Maule": ["Talca", "Curic√≥", "Linares"],
            };
            const regionSelect = document.getElementById('region-select');
            const comunaSelect = document.getElementById('comuna-select');
            
            function populateRegions() {
                regionSelect.innerHTML = '<option value="">Selecciona una Regi√≥n</option>';
                Object.keys(locations).forEach(region => regionSelect.add(new Option(region, region)));
            }
            regionSelect.addEventListener('change', () => {
                comunaSelect.innerHTML = '<option value="">Selecciona una Comuna</option>';
                const comunas = locations[regionSelect.value] || [];
                comunas.forEach(comuna => comunaSelect.add(new Option(comuna, comuna)));
            });

            function renderSummary() {
                const content = `
                    <p><strong>Categor√≠a:</strong> ${orderState.category}</p>
                    <p><strong>Mascota:</strong> ${orderState.petName}, ${orderState.petAge} a√±os</p>
                    <p><strong>Archivos:</strong> ${orderState.hasVideo ? 'Fotos y videos' : 'Solo fotos'}</p>
                    <p><strong>Textos:</strong> ${orderState.surpriseMe ? '¬°Sorpr√©ndeme! Equipo elegir√° los textos.' : 'Personalizados por el cliente.'}</p>
                `;
                document.getElementById('summary-content').innerHTML = content;
            }

            async function showPaymentDetails() {
                const comuna = orderState.shipping.comuna;
                const comunasAfueras = ['Machal√≠', 'Graneros', 'Olivar', 'Do√±ihue', 'Requ√≠noa', 'Codegua', 'Mostazal', 'Coinco', 'Coltauco', 'Rengo'];
                const COSTO_AFUERAS = 5000;
                const COSTO_REGIONES = 8000;
                
                let qrImageName = 'qr_regiones.png';
                orderState.shipping.cost = COSTO_REGIONES;

                if (comuna === 'Rancagua') {
                    qrImageName = 'qr_rancagua.png';
                    orderState.shipping.cost = 0;
                } else if (comunasAfueras.includes(comuna)) {
                    qrImageName = 'qr_afueras.png';
                    orderState.shipping.cost = COSTO_AFUERAS;
                }
                
                const total = orderState.basePrice + orderState.shipping.cost;
                document.getElementById('total-amount').textContent = `$${total.toLocaleString('es-CL')}`;

                const qrImgElement = document.getElementById('qr-code-img');
                const qrContainer = document.getElementById('qr-code-container');
                qrContainer.innerHTML = '<p class="text-xs text-gray-400">Cargando QR...</p>';
                try {
                    const url = await getFirebaseImageUrl(qrImageName);
                    qrImgElement.src = url;
                    qrContainer.innerHTML = '';
                    qrContainer.appendChild(qrImgElement);
                } catch (error) {
                    console.error("Error al cargar QR:", error);
                    qrContainer.innerHTML = '<p class="text-xs text-red-500">No se pudo cargar el QR.</p>';
                }
            }

            // --- NAVEGACI√ìN Y EVENTOS ---
            document.getElementById('start-project-btn').addEventListener('click', () => showSection('category-section'));
            document.getElementById('back-to-category').addEventListener('click', () => showSection('category-section'));
            document.getElementById('to-upload-section').addEventListener('click', () => {
                const petName = document.getElementById('pet-name').value.trim();
                const petAge = document.getElementById('pet-age').value.trim();
                if (!petName || !petAge) {
                    showNotification('Por favor, completa nombre y edad.');
                    return;
                }
                orderState.petName = petName;
                orderState.petAge = petAge;
                showSection('upload-section');
            });
            document.getElementById('back-to-pet-info').addEventListener('click', () => showSection('pet-info-section'));
            document.getElementById('has-video-btn').addEventListener('click', () => {
                orderState.hasVideo = true;
                document.getElementById('video-choice-container').classList.add('hidden');
                document.getElementById('file-inputs-container').classList.remove('hidden');
                document.getElementById('photos-and-video-upload').classList.remove('hidden');
                document.getElementById('photos-only-upload').classList.add('hidden');
            });
            document.getElementById('no-video-btn').addEventListener('click', () => {
                orderState.hasVideo = false;
                document.getElementById('video-choice-container').classList.add('hidden');
                document.getElementById('file-inputs-container').classList.remove('hidden');
                document.getElementById('photos-only-upload').classList.remove('hidden');
                document.getElementById('photos-and-video-upload').classList.add('hidden');
            });
            const surpriseCheckbox = document.getElementById('surprise-me-checkbox');
            const shortTextArea = document.getElementById('short-text');
            const longTextArea = document.getElementById('long-text');
            surpriseCheckbox.addEventListener('change', (e) => {
                orderState.surpriseMe = e.target.checked;
                document.getElementById('surprise-me-text').classList.toggle('hidden', !e.target.checked);
                shortTextArea.disabled = e.target.checked;
                longTextArea.disabled = e.target.checked;
                if (e.target.checked) {
                    shortTextArea.value = '';
                    longTextArea.value = '';
                }
                updateCharCounter('short-text-counter', shortTextArea);
                updateCharCounter('long-text-counter', longTextArea);
            });
            function updateCharCounter(counterId, textarea) {
                const counter = document.getElementById(counterId);
                const limit = counter.textContent.split('/')[1].trim();
                const length = textarea.value.length;
                counter.textContent = `${length} / ${limit}`;
                counter.classList.toggle('text-red-500', length > limit);
                counter.classList.toggle('text-gray-400', length <= limit);
            }
            shortTextArea.addEventListener('input', () => updateCharCounter('short-text-counter', shortTextArea));
            longTextArea.addEventListener('input', () => updateCharCounter('long-text-counter', longTextArea));
            document.getElementById('to-summary-section').addEventListener('click', () => {
                if (orderState.hasVideo === null) {
                    showNotification('Por favor, elige si subir√°s videos o solo fotos.');
                    return;
                }
                orderState.shortText = shortTextArea.value;
                orderState.longText = longTextArea.value;
                renderSummary();
                showSection('summary-section');
            });
            document.getElementById('back-to-upload').addEventListener('click', () => showSection('upload-section'));
            document.getElementById('to-payment-section').addEventListener('click', async () => {
                try {
                    const clientName = document.getElementById('client-name-input').value.trim();
                    const clientPhone = document.getElementById('client-phone-input').value.trim();
                    const region = document.getElementById('region-select').value;
                    const comuna = document.getElementById('comuna-select').value;
                    const address = document.getElementById('address-input').value.trim();
    
                    // Validaci√≥n mejorada para dar feedback espec√≠fico
                    let missingField = '';
                    if (!clientName) missingField = 'Nombre Completo';
                    else if (!clientPhone) missingField = 'Tel√©fono';
                    else if (!region) missingField = 'Regi√≥n';
                    else if (!comuna) missingField = 'Comuna';
                    else if (!address) missingField = 'Direcci√≥n';
    
                    if (missingField) {
                        showNotification(`Por favor, completa el campo: ${missingField}.`);
                        return;
                    }
    
                    orderState.clientName = clientName;
                    orderState.clientPhone = clientPhone;
                    orderState.shipping.region = region;
                    orderState.shipping.comuna = comuna;
                    orderState.shipping.address = address;
    
                    await showPaymentDetails();
                    showSection('payment-section');
                } catch (error) {
                    console.error("Error al procesar para el pago:", error);
                    showNotification("Ocurri√≥ un error inesperado. Int√©ntalo de nuevo.");
                }
            });
            document.getElementById('back-to-summary').addEventListener('click', () => showSection('summary-section'));
            document.getElementById('whatsapp-btn').addEventListener('click', async (e) => {
                const button = e.currentTarget;
                const buttonText = document.getElementById('whatsapp-btn-text');
                const spinner = document.getElementById('whatsapp-btn-spinner');

                button.disabled = true;
                buttonText.textContent = 'Registrando pedido...';
                spinner.classList.remove('hidden');

                try {
                    await sendDataToGoogleSheet();
                    const whatsappNumber = '56946902340';
                    const message = encodeURIComponent(`¬°Hola! Te contacto desde "Las Huellitas de mi Vida" para enviar mi comprobante de pago por el pedido de ${orderState.petName}. üêæ`);
                    window.open(`https://wa.me/${whatsappNumber}?text=${message}`, '_blank');
                } catch (error) {
                    console.error('Error al enviar a Google Sheet:', error);
                    showNotification('Hubo un error al registrar tu pedido. Cont√°ctanos.');
                } finally {
                    button.disabled = false;
                    buttonText.textContent = 'Enviar Comprobante por WhatsApp ‚úîÔ∏è';
                    spinner.classList.add('hidden');
                }
            });
            
            // Cargar datos de Firebase y mostrar la secci√≥n inicial
            populateRegions();
            loadCategoriesFromFirestore();
            loadGalleryImages(); 
            showSection('home-section');
        });

    </script>
</body>
</html>

