<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Las Huellitas de mi Vida</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Fredoka -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos base y de dise√±o especificados en el Prompt Maestro */
        body {
            background: linear-gradient(135deg, #2b1634, #1f143a);
            font-family: 'Fredoka', sans-serif;
            color: #F0F0F0;
            scroll-behavior: smooth;
        }
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
        }
        .main-button {
            background: linear-gradient(90deg, #8E2DE2, #4A00E0);
            box-shadow: 0 0 15px rgba(142, 45, 226, 0.6);
            transition: all 0.3s ease-in-out;
        }
        .main-button:hover:not(:disabled) {
            box-shadow: 0 0 30px rgba(142, 45, 226, 1);
            transform: translateY(-3px) scale(1.05);
        }
        .main-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .secondary-button {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease-in-out;
        }
        .secondary-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: #00FFFF;
        }
        .category-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .category-card:before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 0.75rem; /* rounded-xl */
            border: 2px solid transparent;
            background: linear-gradient(45deg, #00FFFF, #FF00FF) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: destination-out;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .category-card:hover:before {
            opacity: 1;
        }
        .category-card:hover {
            transform: translateY(-5px);
        }
        .form-input, .form-textarea, .form-select {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #FF00FF;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
            background-color: rgba(0, 0, 0, 0.3);
        }
        .backdrop-blur-md {
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }
        .section-fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .paw-bg-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .paw-bg-container img {
            position: absolute;
            opacity: 0.2;
            filter: brightness(1.2);
        }
        .thumbnail-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }
        .thumbnail-image.active {
            border-color: #00FFFF;
        }
        .gallery-image-hover {
            transition: transform 0.3s ease-in-out;
        }
        .gallery-image-hover:hover {
            transform: scale(1.05);
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .gradient-divider {
            height: 2px;
            border: 0;
            background: linear-gradient(90deg, transparent, #8E2DE2, #4A00E0, transparent);
        }
        .mercadopago-button {
            transition: all 0.3s ease-in-out !important;
            box-shadow: 0 4px 15px rgba(0, 129, 255, 0.4) !important;
            transform: scale(1.1); /* Hacemos el bot√≥n un 10% m√°s grande */
        }
        .mercadopago-button:hover {
            box-shadow: 0 6px 25px rgba(0, 129, 255, 0.6) !important;
            transform: scale(1.15); /* Un poco m√°s grande al pasar el mouse */
        }
    </style>
</head>
<body class="antialiased overflow-x-hidden">

    <!-- Cachorro asom√°ndose -->
    <img id="peeking-dog" src="https://i.ibb.co/DfH4TPB8/Dise-o-sin-t-tulo-7.png" alt="Cachorro asom√°ndose" class="hidden fixed bottom-0 left-0 w-40 md:w-56 z-40">
    <!-- Gato asom√°ndose -->
    <img id="peeking-cat" src="https://i.ibb.co/spPvfb9H/Dise-o-sin-t-tulo-6.png" alt="Gato asom√°ndose" class="hidden fixed bottom-0 right-0 w-40 md:w-56 z-40">
    <!-- Familia de mascotas asom√°ndose -->
    <img id="peeking-family" src="https://i.ibb.co/7dRW4ZMY/Dise-o-sin-t-tulo-9.png" alt="Familia de mascotas asom√°ndose" class="hidden fixed bottom-0 left-0 w-40 md:w-56 z-40">


    <!-- Huellas Decorativas de Fondo -->
    <div class="paw-bg-container">
        <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella" style="width: 15%; top: 10%; left: 5%; transform: rotate(-20deg);">
        <img src="https://i.ibb.co/mFSBSN3X/huellas-2.png" alt="huella" style="width: 10%; top: 20%; right: 10%; transform: rotate(15deg);">
        <img src="https://i.ibb.co/vx7Wb795/huellas.png" alt="huella" style="width: 8%; bottom: 15%; left: 20%; transform: rotate(30deg);">
        <img src="https://i.ibb.co/ttbd6wP/huellas-4.png" alt="huella" style="width: 12%; bottom: 5%; right: 15%; transform: rotate(-10deg);">
        <img src="https://i.ibb.co/MDZYf540/huellas-6.png" alt="huella" style="width: 9%; top: 55%; left: 10%; transform: rotate(5deg);">
        <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella" style="width: 7%; top: 70%; right: 5%; transform: rotate(25deg);">
    </div>

    <!-- Header Fijo -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-black/20 backdrop-blur-md h-20">
        <!-- Contenedor de grilla que ocupa el 100% del ancho del viewport -->
        <div class="w-full h-full px-6 grid grid-cols-3 items-center">
            
            <!-- Columna Izquierda: Huellas alineadas al inicio -->
            <div class="hidden md:flex items-center gap-x-4 justify-self-start">
                <img src="https://i.ibb.co/MDZYf540/huellas-6.png" alt="huella" class="h-7 transform rotate-45">
                <img src="https://i.ibb.co/ttbd6wP/huellas-4.png" alt="huella" class="h-7 transform rotate-25">
                <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella" class="h-7 transform -rotate-12">
                <img src="https://i.ibb.co/mFSBSN3X/huellas-2.png" alt="huella" class="h-7 transform rotate-15">
                <img src="https://i.ibb.co/vx7Wb795/huellas.png" alt="huella" class="h-7 transform -rotate-25">
            </div>

            <!-- Columna Central: Logo y T√≠tulo -->
            <div class="flex items-center justify-self-center">
                <img id="header-logo" src="https://i.ibb.co/4R3Rx0Vx/Gemini_Generated_Image-b8hqcvb8hqcvb8hq.png" alt="Logo" class="h-10 w-10 mr-4 rounded-full flex-shrink-0">
                <h1 class="text-2xl md:text-3xl font-bold tracking-wider text-center whitespace-nowrap">Las Huellitas de mi Vida</h1>
            </div>

            <!-- Columna Derecha: Huellas alineadas al final -->
            <div class="hidden md:flex items-center gap-x-4 justify-self-end">
                 <img src="https://i.ibb.co/vx7Wb795/huellas.png" alt="huella" class="h-7 transform -rotate-15">
                 <img src="https://i.ibb.co/ttbd6wP/huellas-4.png" alt="huella" class="h-7 transform rotate-12">
                 <img src="https://i.ibb.co/MDZYf540/huellas-6.png" alt="huella" class="h-7 transform rotate-30">
                 <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella" class="h-7 transform -rotate-25">
                 <img src="https://i.ibb.co/mFSBSN3X/huellas-2.png" alt="huella" class="h-7 transform rotate-45">
            </div>
        </div>
    </header>

    <!-- Modal para ver imagen en grande -->
    <div id="image-modal" class="modal-overlay hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 opacity-0">
        <div class="modal-content relative max-w-3xl max-h-[90vh] transform scale-95">
            <img id="modal-img" src="" alt="Vista ampliada" class="w-full h-full object-contain rounded-lg">
            <button id="close-modal" class="absolute -top-4 -right-4 h-10 w-10 bg-white text-black rounded-full text-2xl font-bold">&times;</button>
        </div>
    </div>

    <!-- Contenedor Principal de la App -->
    <main id="app-container" class="container mx-auto px-6 pt-28 pb-12 min-h-screen flex flex-col justify-center">

        <!-- PASO 1: P√°gina Principal (Hero) -->
        <section id="home-section" class="text-center section-fade-in">
            <h2 class="text-4xl md:text-5xl font-bold mt-8 mb-4">Cada huella cuenta una historia&nbsp;üêæ</h2>
            <p class="text-xl text-gray-300 mb-8 max-w-2xl mx-auto">Transformemos tus recuerdos m√°s preciados en una obra de arte inolvidable.</p>
            <div class="my-8 flex justify-center">
                <img id="hero-image" src="https://i.ibb.co/0jRX3VX2/PORTADA-HUELLitas-3.png" alt="Collage de mascotas" class="max-w-2xl w-full rounded-2xl shadow-2xl">
            </div>
            <button id="start-project-btn" class="main-button text-white font-bold py-3 px-8 rounded-full text-lg">
                Elige tu Proyecto&nbsp;üêæ
            </button>

            <!-- SECCI√ìN DE GALER√çA -->
            <div id="gallery-section" class="mt-24">
                <div class="flex justify-center mb-8">
                    <img src="https://i.ibb.co/4R3Rx0Vx/Gemini_Generated_Image-b8hqcvb8hqcvb8hq.png" alt="Logo Decorativo" class="w-full max-w-5xl aspect-square rounded-full">
                </div>
                <h2 class="text-4xl font-bold mb-8">Nuestros Dise√±os&nbsp;üêæ</h2>
                <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-5xl mx-auto">
                    <!-- Las im√°genes de la galer√≠a se cargar√°n aqu√≠ -->
                </div>
            </div>
        </section>

        <!-- PASO 2: Selecci√≥n de Categor√≠a -->
        <section id="category-section" class="hidden text-center section-fade-in">
            <h2 class="text-4xl font-bold mt-8 mb-8">¬øQu√© historia vamos a contar hoy?&nbsp;üêæ</h2>
            <div id="category-grid" class="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                <!-- Las categor√≠as se cargar√°n aqu√≠ desde Firebase -->
            </div>
        </section>

        <!-- PASO 3: Formulario Datos de la Mascota -->
        <section id="pet-info-section" class="hidden section-fade-in">
            <div class="max-w-lg mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                <div class="flex justify-center mb-4">
                    <img id="product-image-preview" src="" alt="Producto seleccionado" class="rounded-lg max-h-40 shadow-lg cursor-pointer transition-transform duration-300 hover:scale-105">
                </div>
                <div id="thumbnail-container" class="flex justify-center gap-2 mb-6">
                    <!-- Las miniaturas se generar√°n aqu√≠ con JavaScript -->
                </div>
                <h2 id="pet-info-title" class="text-3xl font-bold text-center mb-6">Datos de tu Mascota</h2>
                <div class="space-y-6">
                    <div>
                        <label for="pet-name" class="block text-sm font-medium text-[#00FFFF] mb-1">Nombre de tu mascota</label>
                        <input type="text" id="pet-name" class="form-input w-full p-3 rounded-lg text-white" placeholder="Ej: Tat√°n" autocomplete="off">
                    </div>
                    <div>
                        <label for="pet-age" class="block text-sm font-medium text-[#00FFFF] mb-1">Edad (en a√±os humanos)</label>
                        <input type="number" id="pet-age" class="form-input w-full p-3 rounded-lg text-white" placeholder="Ej: 2" autocomplete="off">
                    </div>
                    <div class="flex justify-between items-center pt-4">
                        <button id="back-to-category" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                        <button id="to-upload-section" class="main-button text-white font-bold py-2 px-6 rounded-full">Continuar</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- PASO 4: Formulario Carga de Archivos -->
        <section id="upload-section" class="hidden section-fade-in">
            <div class="max-w-lg mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                <h2 class="text-3xl font-bold text-center mb-6">Ahora, sube tus recuerdos&nbsp;üêæ</h2>
                
                <div class="p-4 mb-6 bg-cyan-900/50 border border-cyan-500 rounded-lg text-center">
                    <p class="text-cyan-200 text-sm">üì∂ Para una subida m√°s r√°pida, te recomendamos conectarte a una red Wi-Fi.</p>
                </div>

                <div id="video-choice-container" class="text-center">
                    <p class="text-[#00FFFF] mb-4">¬øIncluir√°s videos en tu homenaje?</p>
                    <div class="flex justify-center gap-4">
                        <button id="has-video-btn" class="main-button font-bold py-3 px-6 rounded-full">S√≠, tengo videos&nbsp;üé¨</button>
                        <button id="no-video-btn" class="secondary-button font-bold py-3 px-6 rounded-full">No, usar√© solo fotos&nbsp;üñºÔ∏è</button>
                    </div>
                </div>

                <div id="file-inputs-container" class="hidden space-y-6 mt-6">
                    <div id="photos-and-video-upload" class="hidden space-y-4">
                        <div>
                            <label for="photo-input-multi" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga tus fotos</label>
                            <input type="file" id="photo-input-multi" multiple accept="image/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                        </div>
                        <div>
                            <label for="video-input-multi" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga tus videos</label>
                            <input type="file" id="video-input-multi" multiple accept="video/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                        </div>
                    </div>
                    <div id="photos-only-upload" class="hidden">
                        <label for="photo-input-only" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga tus fotos</label>
                        <p class="text-xs text-gray-400 mb-2">Con ellas crearemos un video emotivo para el QR de tu obra.</p>
                        <input type="file" id="photo-input-only" multiple accept="image/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                    </div>

                    <div>
                        <label for="short-text" class="block text-sm font-medium text-[#00FFFF] mb-1">Texto Corto (Opcional)</label>
                        <textarea id="short-text" rows="3" class="form-textarea w-full p-3 rounded-lg text-white" placeholder="Una frase o fecha especial..."></textarea>
                    </div>
                    <div>
                        <label for="long-text" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Historia (Opcional)</label>
                        <textarea id="long-text" rows="5" class="form-textarea w-full p-3 rounded-lg text-white" placeholder="Cu√©ntanos un poco sobre tu amiguito, sus gustos, alguna an√©cdota..."></textarea>
                    </div>
                    <div class="flex items-center space-x-3 p-3 bg-yellow-900/20 rounded-lg">
                        <input id="surprise-me-checkbox" type="checkbox" class="h-5 w-5 rounded bg-transparent border-yellow-400 text-yellow-500 focus:ring-yellow-600">
                        <label for="surprise-me-checkbox" class="font-bold text-yellow-300">¬°Sorpr√©ndeme!&nbsp;üêæ</label>
                    </div>
                    <p id="surprise-me-text" class="text-xs text-yellow-400 hidden">Al marcar esta opci√≥n, con mucho respeto, empat√≠a y amor, buscaremos el texto adecuado para tu obra.</p>

                    <div class="flex justify-between items-center pt-4">
                        <button id="back-to-pet-info" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                        <button id="to-summary-section" class="main-button text-white font-bold py-2 px-6 rounded-full flex items-center justify-center">
                            <span id="to-summary-btn-text">Subir y continuar</span>
                            <svg id="to-summary-btn-spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Barra de progreso movida a su nueva ubicaci√≥n -->
                    <div id="progress-container" class="hidden w-full bg-gray-700 rounded-full h-4 mt-4 relative">
                        <div id="progress-bar" class="bg-gradient-to-r from-green-400 to-cyan-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                        <span id="progress-text" class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white"></span>
                    </div>

                </div>
            </div>
        </section>

        <!-- PASO 5: Resumen y Despacho -->
        <section id="summary-section" class="hidden section-fade-in">
            <div class="max-w-xl mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                <h2 class="text-3xl font-bold text-center mb-6">Revisa tu Pedido</h2>
                <div id="summary-content" class="space-y-4 mb-8 p-4 bg-white/5 rounded-lg">
                    <!-- El resumen del pedido se inyectar√° aqu√≠ -->
                </div>
                <h3 class="text-2xl font-bold text-center mb-4">Informaci√≥n de Despacho</h3>
                <div id="shipping-form" class="space-y-4">
                    <div>
                        <label for="client-name-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Nombre Completo</label>
                        <input type="text" id="client-name-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="Para el registro del pedido">
                    </div>
                    <div>
                        <label for="client-phone-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Tel√©fono (WhatsApp)</label>
                        <input type="tel" id="client-phone-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="+56 9 1234 5678">
                    </div>
                    <div>
                        <label for="region-select" class="block text-sm font-medium text-[#00FFFF] mb-1">Regi√≥n</label>
                        <select id="region-select" class="form-select w-full p-3 rounded-lg text-white"></select>
                    </div>
                    <div>
                        <label for="comuna-select" class="block text-sm font-medium text-[#00FFFF] mb-1">Comuna</label>
                        <select id="comuna-select" class="form-select w-full p-3 rounded-lg text-white"></select>
                    </div>
                    <div>
                        <label for="address-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Direcci√≥n</label>
                        <input type="text" id="address-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="Calle, n√∫mero, depto/casa">
                    </div>
                </div>
                <div class="flex justify-between items-center pt-6">
                    <button id="back-to-upload" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                    <button id="to-payment-section" class="main-button text-white font-bold py-2 px-6 rounded-full flex items-center justify-center">
                        <span id="to-payment-btn-text">Continuar al Pago</span>
                        <svg id="to-payment-btn-spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </section>

        <!-- PASO 6: Pago Y CONFIRMACI√ìN FINAL -->
        <section id="payment-section" class="hidden section-fade-in">
            <div class="max-w-xl mx-auto bg-black/20 p-8 rounded-xl border border-white/10 text-center">
                <h2 class="text-3xl font-bold mb-2">Paso Final: Pago Seguro üîí</h2>
                <p class="text-gray-300 mb-6">Est√°s a punto de inmortalizar tu recuerdo. Realiza el pago de forma segura a trav√©s de Mercado Pago.</p>
                
                <hr class="gradient-divider my-8">

                <!-- Resumen de la Obra -->
                <div id="payment-summary" class="text-left my-6 p-4 bg-white/5 rounded-lg space-y-2">
                    <!-- El resumen se inyectar√° aqu√≠ din√°micamente -->
                </div>

                <div class="my-6">
                    <p class="text-lg text-gray-400 uppercase tracking-wider">Monto Total a Pagar</p>
                    <p id="total-amount" class="text-5xl font-bold text-green-400 my-2"></p>
                </div>

                <div class="my-8 p-6 bg-white/5 rounded-lg max-w-md mx-auto">
                     <img src="https://i.ibb.co/BKnVhZC4/Dise-o-sin-t-tulo-11.png" alt="Paga con Mercado Pago" class="w-72 mx-auto mb-4">
                    
                    <!-- Contenedor para los botones de Mercado Pago -->
                    <div id="payment-buttons-container" class="mt-4 flex justify-center min-h-[50px]">
                        <!-- Bot√≥n para Rancagua (119.990) -->
                        <div id="mp-button-rancagua" class="hidden">
                            <script src="https://www.mercadopago.cl/integrations/v1/web-payment-checkout.js"
                            data-preference-id="1380939166-aecc0d0a-9957-4fe5-b9c8-157f0b482c14" data-source="button">
                            </script>
                        </div>
                        <!-- Bot√≥n para Aleda√±os (124.990) -->
                        <div id="mp-button-aledanos" class="hidden">
                            <script src="https://www.mercadopago.cl/integrations/v1/web-payment-checkout.js"
                            data-preference-id="1380939166-a7ab1f73-ac49-4a42-b0ad-380c53e64d90" data-source="button">
                            </script>
                        </div>
                        <!-- Bot√≥n para Otras Regiones (127.990) -->
                        <div id="mp-button-regiones" class="hidden">
                            <script src="https://www.mercadopago.cl/integrations/v1/web-payment-checkout.js"
                            data-preference-id="1380939166-e34674ab-a39b-46a8-8d08-9568552f3dba" data-source="button">
                            </script>
                        </div>
                    </div>
                </div>

                <hr class="gradient-divider my-8">

                <div class="mt-8">
                    <button id="back-to-summary" class="secondary-button font-bold py-3 px-8 text-lg rounded-full shadow-lg hover:shadow-xl transition-all duration-300">Volver y revisar</button>
                </div>
            </div>
        </section>

        <!-- PASO 7: P√ÅGINA DE CONFIRMACI√ìN (Gracias) -->
        <section id="thank-you-section" class="hidden section-fade-in text-center">
            <div class="max-w-xl mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                <h2 class="text-4xl font-bold mb-4">¬°Pedido Recibido con √âxito! üéâ</h2>
                <p class="text-lg text-gray-300 mb-6">Hemos confirmado tu pago y tu pedido ya est√° en nuestras manos. ¬°Gracias por confiar en nosotros para inmortalizar tu recuerdo!</p>
                
                <div class="my-8 p-6 bg-white/5 rounded-lg border border-dashed border-gray-500">
                    <p class="text-gray-400 uppercase tracking-wider">Tu C√≥digo de Pedido es:</p>
                    <p id="final-order-id" class="text-4xl font-bold text-green-400 my-2 tracking-widest"></p>
                    <p class="text-xs text-gray-500 mt-2">Guarda este c√≥digo, es tu llave para el seguimiento.</p>
                </div>

                <p class="text-lg text-gray-300 mb-6">El √∫ltimo paso es contactarnos por WhatsApp para afinar los detalles finales de tu obra de arte.</p>
                
                <a id="whatsapp-contact-btn" href="#" target="_blank" class="main-button inline-block text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg hover:shadow-2xl">
                    Contactar por WhatsApp üêæ
                </a>

                <div class="mt-12">
                     <button id="start-new-order-btn" class="secondary-button text-sm font-bold py-2 px-6 rounded-full">Crear un nuevo pedido</button>
                </div>
            </div>
        </section>

    </main>

    <footer class="text-center py-16 mt-24 border-t border-white/10">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="grid md:grid-cols-2 gap-12 text-center md:text-left">
                <div>
                    <h3 class="text-2xl font-bold mb-4 text-[#00FFFF]">Nuestra Misi√≥n üêæ</h3>
                    <p class="text-gray-300">Inmortalizar el amor incondicional entre las mascotas y sus due√±os a trav√©s de obras de arte √∫nicas y personalizadas, creadas con la m√°s profunda empat√≠a y dedicaci√≥n para honrar cada huella que dejan en nuestras vidas.</p>
                </div>
                <div>
                    <h3 class="text-2xl font-bold mb-4 text-[#00FFFF]">Nuestra Visi√≥n üêæ</h3>
                    <p class="text-gray-300">Ser el referente principal en la creaci√≥n de homenajes art√≠sticos para mascotas, reconocidos por nuestra capacidad de transformar recuerdos en tesoros eternos que brinden consuelo, alegr√≠a y celebren el v√≠nculo sagrado que compartimos con ellos.</p>
                </div>
            </div>
            <div class="mt-12 text-sm text-gray-500">
                <p>&copy; 2025 Las Huellitas de mi Vida. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Notificaci√≥n Toast -->
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-red-500 text-white py-3 px-6 rounded-full shadow-lg text-center z-[100] opacity-0 transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>
    
    <script type="module">
        // --- IMPORTS DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- CONFIGURACI√ìN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDR42aJIpDkXL5T2vgj-J2ceZFVZCqzCms",
            authDomain: "las-huellitas-de-mi-vida.firebaseapp.com",
            projectId: "las-huellitas-de-mi-vida",
            storageBucket: "las-huellitas-de-mi-vida.firebasestorage.app",
            messagingSenderId: "1095265611249",
            appId: "1:1095265611249:web:09930aaef56d0736bea850",
            measurementId: "G-0QB83X7TBC"
        };

        // Inicializaci√≥n de los servicios de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // --- ESTADO GLOBAL DE LA APLICACI√ìN ---
        // Este objeto almacena toda la informaci√≥n del pedido a medida que el usuario avanza.
        const orderState = {
            category: '',
            categoryIcon: '', // Para el resumen final
            categorySize: '', // Para el resumen final
            basePrice: 0,
            imageUrls: [],
            petName: '',
            petAge: '',
            clientName: '',
            clientPhone: '',
            orderId: '',
            shortText: '',
            longText: '',
            surpriseMe: false,
            shipping: {
                region: '',
                comuna: '',
                address: '',
                cost: 0,
            },
            firebaseFolderUrl: '' // URL a la carpeta de archivos en Firebase Storage
        };
        
        // --- CONSTANTES ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwkVHyYouOTFEzUhmKyuU_Yw0D0xrp9szRJ-aCnINaB4hpkurFWbYILOGNmSNBoolClSQ/exec';
        const peekingDog = document.getElementById('peeking-dog');
        const peekingCat = document.getElementById('peeking-cat');
        const peekingFamily = document.getElementById('peeking-family');
        
        // --- FUNCIONES UTILITARIAS ---
        
        /**
         * Muestra una secci√≥n espec√≠fica de la p√°gina y oculta las dem√°s.
         * @param {string} sectionId - El ID de la secci√≥n a mostrar.
         */
        function showSection(sectionId) {
            document.querySelectorAll('main > section').forEach(section => section.classList.add('hidden'));
            document.getElementById(sectionId)?.classList.remove('hidden');
            window.scrollTo(0, 0); // Vuelve al inicio de la p√°gina

            // L√≥gica para mostrar/ocultar animales decorativos
            peekingDog.classList.add('hidden');
            peekingCat.classList.add('hidden');
            peekingFamily.classList.add('hidden');

            if (sectionId === 'pet-info-section') {
                if (orderState.category === 'Homenaje a su Vida') {
                    peekingDog.classList.remove('hidden');
                } else if (orderState.category === 'Celebrando la Vida de tu querida mascota.') {
                    peekingCat.classList.remove('hidden');
                } else if (orderState.category === 'Celebrando la Nueva Familia') {
                    peekingFamily.classList.remove('hidden');
                }
            }
        }

        /**
         * Muestra una notificaci√≥n emergente (toast).
         * @param {string} message - El mensaje a mostrar.
         * @param {boolean} isError - Si es true, la notificaci√≥n ser√° roja (error), si no, verde (√©xito).
         */
        function showNotification(message, isError = true) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-full shadow-lg text-center z-[100] transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            
            setTimeout(() => { toast.classList.remove('opacity-0'); }, 10);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 500);
            }, 5000);
        }

        /**
         * Genera un ID de pedido √∫nico.
         * @returns {string} El ID generado, ej: "HUELLITAS-A1B2C3".
         */
        function generateOrderId() {
            const prefix = "HUELLITAS";
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ012356789";
            let result = "";
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return `${prefix}-${result}`;
        }

        // --- FUNCIONES DE CARGA DE DATOS (FIREBASE) ---

        /**
         * Carga las im√°genes de la galer√≠a principal desde Firestore.
         */
        async function loadGallery() {
            const grid = document.getElementById("gallery-grid");
            grid.innerHTML = `<p class="text-center col-span-full">Cargando galer√≠a...</p>`;
            try {
                const docRef = doc(db, "gallery", "paginaPrincipal");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().imageUrls) {
                    grid.innerHTML = '';
                    docSnap.data().imageUrls.forEach(url => {
                        grid.innerHTML += `
                            <div class="rounded-lg overflow-hidden shadow-lg aspect-square">
                                <img src="${url}" alt="Obra de arte" class="w-full h-full object-cover gallery-image-hover">
                            </div>`;
                    });
                } else {
                    grid.innerHTML = `<p class="text-yellow-400 text-center col-span-full">No se encontraron im√°genes en la galer√≠a.</p>`;
                }
            } catch (error) {
                console.error("Error al cargar la galer√≠a:", error);
                grid.innerHTML = `<p class="text-red-500 text-center col-span-full">No se pudo cargar la galer√≠a.</p>`;
            }
        }
        
        /**
         * Carga las categor√≠as de productos desde Firestore y configura los eventos de click.
         */
        async function loadCategories() {
            const grid = document.getElementById("category-grid");
            grid.innerHTML = `<p class="text-center col-span-full">Cargando proyectos...</p>`;
            try {
                const querySnapshot = await getDocs(collection(db, "categories"));
                if (querySnapshot.empty) {
                    grid.innerHTML = `<p class="text-yellow-400 text-center col-span-full">No hay categor√≠as disponibles.</p>`;
                    return;
                }
                grid.innerHTML = '';
                const categories = [];
                querySnapshot.forEach(doc => categories.push(doc.data()));
                
                // Ordenar categor√≠as por el campo 'order'
                categories.sort((a, b) => (a.order || 99) - (b.order || 99));

                categories.forEach(data => {
                    grid.innerHTML += `
                        <div class="category-card rounded-xl cursor-pointer flex flex-col text-center p-4" data-category='${JSON.stringify(data)}'>
                            <div class="flex flex-col flex-grow items-center">
                                <div class="text-6xl mb-4">${data.icon || 'üêæ'}</div>
                                <h3 class="text-xl font-bold mb-1">${data.name}</h3>
                                <p class="text-gray-400 text-xs mb-2">${data.size}</p>
                                <p class="text-gray-300 text-sm flex-grow">${data.description}</p>
                            </div>
                        </div>`;
                });

                document.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const data = JSON.parse(e.currentTarget.dataset.category);
                        orderState.category = data.name;
                        orderState.categoryIcon = data.icon || 'üêæ';
                        orderState.categorySize = data.size || 'No especificado';
                        orderState.basePrice = Number(data.price || 119990); // Precio base por defecto
                        orderState.imageUrls = data.imageUrls || [];
                        
                        const preview = document.getElementById('product-image-preview');
                        const thumbs = document.getElementById('thumbnail-container');
                        thumbs.innerHTML = '';
                        
                        if (orderState.imageUrls.length > 0) {
                            preview.src = orderState.imageUrls[0];
                            orderState.imageUrls.forEach((url, index) => {
                                const thumb = document.createElement('img');
                                thumb.src = url;
                                thumb.className = 'thumbnail-image' + (index === 0 ? ' active' : '');
                                thumb.onclick = () => {
                                    preview.src = url;
                                    document.querySelectorAll('.thumbnail-image').forEach(t => t.classList.remove('active'));
                                    thumb.classList.add('active');
                                };
                                thumbs.appendChild(thumb);
                            });
                        } else {
                            preview.src = 'https://placehold.co/400x300/333/FFF?text=Sin+Imagen';
                        }
                        
                        document.getElementById('pet-info-title').textContent = `Proyecto: ${orderState.category}`;
                        showSection('pet-info-section');
                    });
                });

            } catch (error) {
                console.error("Error al cargar categor√≠as:", error);
                grid.innerHTML = `<p class="text-red-500 text-center col-span-full">No se pudo cargar el contenido.</p>`;
            }
        }

        // --- L√ìGICA DE NEGOCIO Y SUBIDA DE ARCHIVOS ---

        /**
         * Renderiza el resumen del producto en la p√°gina de pago.
         */
        function renderPaymentSummary() {
            const summaryContainer = document.getElementById('payment-summary');
            const materials = "Terminaciones en vidrio opaco, fotograf√≠as impresas en papel fotogr√°fico premium mate, l√°pices pastel seco, acr√≠licos, acuarelas, rotuladores de tinta, fijadores y barnices.";
            
            summaryContainer.innerHTML = `
                <h4 class="text-xl font-bold text-center mb-4 text-[#00FFFF]">Detalles de tu Obra</h4>
                <p><strong>Proyecto:</strong> ${orderState.categoryIcon} ${orderState.category}</p>
                <p><strong>Tama√±o:</strong> ${orderState.categorySize}</p>
                <p><strong>Materiales:</strong> ${materials}</p>
            `;
        }

        /**
         * Sube los archivos seleccionados por el usuario a Firebase Storage.
         * @param {string} orderId - El ID del pedido para crear la carpeta en Storage.
         * @returns {Promise<void>} Una promesa que se resuelve cuando todos los archivos han sido subidos.
         */
        async function uploadFilesToFirebase(orderId) {
            const photoInput = orderState.hasVideo ? document.getElementById('photo-input-multi') : document.getElementById('photo-input-only');
            const videoInput = orderState.hasVideo ? document.getElementById('video-input-multi') : null;

            // Juntar todos los archivos (fotos y videos) en un solo array.
            let filesToUpload = [...photoInput.files];
            if (videoInput && videoInput.files.length > 0) {
                filesToUpload.push(...videoInput.files);
            }
            
            // Si el usuario no eligi√≥ "Sorpr√©ndeme" y escribi√≥ textos, crea un archivo .txt con esa informaci√≥n.
            const textContent = `ID Pedido: ${orderState.orderId}\nNombre Mascota: ${orderState.petName}\n\nTexto Corto:\n${orderState.shortText}\n\nHistoria:\n${orderState.longText}`;
            if (!orderState.surpriseMe && (orderState.shortText || orderState.longText)) {
                const textBlob = new Blob([textContent], { type: 'text/plain' });
                const textFile = new File([textBlob], "datos_cliente.txt", {type: "text/plain"});
                filesToUpload.push(textFile);
            }
            
            const totalSize = filesToUpload.reduce((acc, file) => acc + file.size, 0);
            const individualProgress = {}; // Objeto para rastrear el progreso de cada archivo
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('progress-container');
            const progressText = document.getElementById('progress-text'); // NEW: Get the text element
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = '0%'; // NEW: Initialize text

            // Crear un array de promesas, una por cada archivo a subir.
            const uploadPromises = filesToUpload.map(file => {
                return new Promise((resolve, reject) => {
                    const fileRef = ref(storage, `pedidos/${orderId}/${file.name}`);
                    const uploadTask = uploadBytesResumable(fileRef, file);

                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            // Actualizar el progreso general
                            individualProgress[file.name] = snapshot.bytesTransferred;
                            let totalBytesUploaded = Object.values(individualProgress).reduce((a, b) => a + b, 0);
                            const progress = totalSize > 0 ? Math.round((totalBytesUploaded / totalSize) * 100) : 0;
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `${progress}%`; // NEW: Update text
                        }, 
                        (error) => {
                            console.error("Fallo la subida para:", file.name, error);
                            reject(error);
                        }, 
                        () => {
                            // La subida del archivo se complet√≥
                            individualProgress[file.name] = file.size;
                            let totalBytesUploaded = Object.values(individualProgress).reduce((a, b) => a + b, 0);
                            const progress = totalSize > 0 ? Math.round((totalBytesUploaded / totalSize) * 100) : 0;
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `${progress}%`; // NEW: Update text on complete
                            resolve();
                        }
                    );
                });
            });

            // Esperar a que todas las promesas de subida se completen.
            await Promise.all(uploadPromises);
            console.log("--- SUBIDA COMPLETADA ---");
        }

        /**
         * Env√≠a los datos del pedido a un script de Google Sheets.
         */
        async function sendOrderToGoogleSheet() {
            const formData = new FormData();
            formData.append('timestamp', new Date().toLocaleString("es-CL"));
            formData.append('orderId', orderState.orderId);
            formData.append('category', orderState.category);
            formData.append('petName', orderState.petName);
            formData.append('petAge', orderState.petAge);
            formData.append('clientName', orderState.clientName || '');
            formData.append('address', `${orderState.shipping.address}, ${orderState.shipping.comuna}, ${orderState.shipping.region}`);
            formData.append('phone', orderState.clientPhone || '');
            formData.append('shippingCost', orderState.shipping.cost);
            formData.append('totalPaid', orderState.basePrice + orderState.shipping.cost);
            formData.append('shortText', orderState.surpriseMe ? '¬°Sorpr√©ndeme!' : orderState.shortText);
            formData.append('longText', orderState.surpriseMe ? '¬°Sorpr√©ndeme!' : orderState.longText);
            formData.append('filesLink', orderState.firebaseFolderUrl);
            
            // Se usa 'no-cors' porque el script de Google no devuelve las cabeceras CORS necesarias,
            // pero la solicitud POST se completa igualmente en el servidor.
            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData, mode: 'no-cors' });
        }

        // --- INICIALIZACI√ìN DE LA APLICACI√ìN ---
        document.addEventListener('DOMContentLoaded', async () => {
            // --- DETECCI√ìN DE REDIRECCI√ìN DE MERCADO PAGO ---
            // Revisa si la URL contiene par√°metros de un pago aprobado.
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('status');

            if (paymentStatus === 'approved') {
                const savedStateJSON = sessionStorage.getItem('huellitasOrderState');
                if (savedStateJSON) {
                    const savedState = JSON.parse(savedStateJSON);
                    
                    // Rellena la p√°gina de "Gracias" con los datos guardados.
                    document.getElementById('final-order-id').textContent = savedState.orderId;
                    const WHATSAPP_NUMBER = '56912345678'; // Reemplazar con tu n√∫mero de WhatsApp
                    const message = `¬°Hola! üëã Acabo de realizar mi pedido a trav√©s de la web. Mi c√≥digo de seguimiento es: *${savedState.orderId}*`;
                    document.getElementById('whatsapp-contact-btn').href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;

                    showSection('thank-you-section');
                    
                    // Limpia los datos para que la p√°gina no se muestre de nuevo al recargar.
                    sessionStorage.removeItem('huellitasOrderState');
                    window.history.replaceState({}, document.title, window.location.pathname); 

                    return; // Detiene la ejecuci√≥n para no cargar la p√°gina de inicio.
                }
            }
            
            const locations = { "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"], "Tarapac√°": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Cami√±a", "Colchane", "Huara", "Pica"], "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollag√ºe", "San Pedro de Atacama", "Tocopilla", "Mar√≠a Elena"], "Atacama": ["Copiap√≥", "Caldera", "Tierra Amarilla", "Cha√±aral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"], "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicu√±a", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbal√°", "Monte Patria", "Punitaqui", "R√≠o Hurtado"], "Valpara√≠so": ["Valpara√≠so", "Casablanca", "Conc√≥n", "Juan Fern√°ndez", "Puchuncav√≠", "Quintero", "Vi√±a del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa Mar√≠a", "Quilpu√©", "Limache", "Olmu√©", "Villa Alemana"], "Metropolitana de Santiago": ["Santiago", "Cerrillos", "Cerro Navia", "Conchal√≠", "El Bosque", "Estaci√≥n Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maip√∫", "√ëu√±oa", "Pedro Aguirre Cerda", "Pe√±alol√©n", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaqu√≠n", "San Miguel", "San Ram√≥n", "Vitacura", "Puente Alto", "Pirque", "San Jos√© de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhu√©", "Curacav√≠", "Mar√≠a Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Pe√±aflor"], "O'Higgins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Do√±ihue", "Graneros", "Las Cabras", "Machal√≠", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requ√≠noa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Ch√©pica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"], "Maule": ["Talca", "Constituci√≥n", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "R√≠o Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curic√≥", "Huala√±√©", "Licant√©n", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuqu√©n", "Linares", "Colb√∫n", "Longav√≠", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"], "√ëuble": ["Chill√°n", "Bulnes", "Chill√°n Viejo", "El Carmen", "Pemuco", "Pinto", "Quill√≥n", "San Ignacio", "Yungay", "Quirihue", "Cobquecura", "Coelemu", "Ninhue", "Portezuelo", "R√°nquil", "Treguaco", "San Carlos", "Coihueco", "√ëiqu√©n", "San Fabi√°n", "San Nicol√°s"], "Biob√≠o": ["Concepci√≥n", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tom√©", "Hualp√©n", "Lebu", "Arauco", "Ca√±ete", "Contulmo", "Curanilahue", "Los √Ålamos", "Tir√∫a", "Los √Ångeles", "Antuco", "Cabrero", "Laja", "Mulch√©n", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa B√°rbara", "Tucapel", "Yumbel", "Alto Biob√≠o"], "Araucan√≠a": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre las Casas", "Perquenco", "Pitrufqu√©n", "Puc√≥n", "Saavedra", "Teodoro Schmidt", "Tolt√©n", "Vilc√∫n", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacaut√≠n", "Ercilla", "Lonquay", "Los Sauces", "Lumaco", "Pur√©n", "Renaico", "Traigu√©n", "Victoria"], "Los R√≠os": ["Valdivia", "Corral", "Lanco", "Los Lagos", "M√°fil", "Mariquina", "Paillaco", "Panguipulli", "La Uni√≥n", "Futrono", "Lago Ranco", "R√≠o Bueno"], "Los Lagos": ["Puerto Montt", "Calbuco", "Cocham√≥", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maull√≠n", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de V√©lez", "Dalcahue", "Puqueld√≥n", "Queil√©n", "Quell√≥n", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "R√≠o Negro", "San Juan de la Costa", "San Pablo", "Chait√©n", "Futaleuf√∫", "Hualaihu√©", "Palena"], "Ays√©n": ["Coyhaique", "Lago Verde", "Ays√©n", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "R√≠o Ib√°√±ez"], "Magallanes": ["Punta Arenas", "Laguna Blanca", "R√≠o Verde", "San Gregorio", "Cabo de Hornos (Ex Navarino)", "Ant√°rtica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"] };
            const regionSelect = document.getElementById('region-select');
            const comunaSelect = document.getElementById('comuna-select');
            
            function populateRegions() {
                regionSelect.innerHTML = '<option value="">Selecciona una Regi√≥n</option>';
                Object.keys(locations).sort().forEach(region => regionSelect.add(new Option(region, region)));
            }
            regionSelect.addEventListener('change', () => {
                comunaSelect.innerHTML = '<option value="">Selecciona una Comuna</option>';
                const comunas = locations[regionSelect.value] || [];
                comunas.sort().forEach(comuna => comunaSelect.add(new Option(comuna, comuna)));
            });

            function renderSummary() {
                document.getElementById('summary-content').innerHTML = `
                    <p><strong>Categor√≠a:</strong> ${orderState.category}</p>
                    <p><strong>Mascota:</strong> ${orderState.petName}, ${orderState.petAge} a√±os</p>
                    <p><strong>ID de Pedido:</strong> ${orderState.orderId}</p>
                    <p><strong>Textos:</strong> ${orderState.surpriseMe ? '¬°Sorpr√©ndeme! Equipo elegir√° los textos.' : 'Personalizados.'}</p>
                    <p class="text-green-400"><strong>Archivos:</strong> Recibidos correctamente ‚úîÔ∏è</p>
                `;
            }

            function showPaymentDetails() {
                const buttons = {
                    rancagua: document.getElementById('mp-button-rancagua'),
                    aledanos: document.getElementById('mp-button-aledanos'),
                    regiones: document.getElementById('mp-button-regiones')
                };
                Object.values(buttons).forEach(btn => btn.classList.add('hidden'));

                const comuna = orderState.shipping.comuna;
                const comunasAledanas = ['Machal√≠', 'Graneros', 'Olivar', 'Do√±ihue', 'Requ√≠noa', 'Codegua', 'Mostazal', 'Coinco', 'Coltauco', 'Rengo'];
                
                let targetButton = buttons.regiones;
                orderState.shipping.cost = 8000;
                if (comuna === 'Rancagua') {
                    targetButton = buttons.rancagua;
                    orderState.shipping.cost = 0;
                } else if (comunasAledanas.includes(comuna)) {
                    targetButton = buttons.aledanos;
                    orderState.shipping.cost = 5000;
                }
                
                document.getElementById('total-amount').textContent = `$${(orderState.basePrice + orderState.shipping.cost).toLocaleString('es-CL')}`;
                
                if (targetButton) {
                    targetButton.classList.remove('hidden');
                }
            }

            // --- MANEJADORES DE EVENTOS (EVENT LISTENERS) ---
            document.getElementById('start-project-btn').addEventListener('click', () => showSection('category-section'));
            document.getElementById('back-to-category').addEventListener('click', () => showSection('category-section'));
            
            document.getElementById('to-upload-section').addEventListener('click', () => {
                const petName = document.getElementById('pet-name').value.trim();
                const petAge = document.getElementById('pet-age').value.trim();
                if (!petName || !petAge) {
                    showNotification('Por favor, completa nombre y edad.');
                    return;
                }
                orderState.petName = petName;
                orderState.petAge = petAge;
                orderState.orderId = generateOrderId();
                showSection('upload-section');
            });

            document.getElementById('back-to-pet-info').addEventListener('click', () => showSection('pet-info-section'));
            document.getElementById('has-video-btn').addEventListener('click', () => {
                orderState.hasVideo = true;
                document.getElementById('video-choice-container').classList.add('hidden');
                document.getElementById('file-inputs-container').classList.remove('hidden');
                document.getElementById('photos-and-video-upload').classList.remove('hidden');
                document.getElementById('photos-only-upload').classList.add('hidden');
            });
            document.getElementById('no-video-btn').addEventListener('click', () => {
                orderState.hasVideo = false;
                document.getElementById('video-choice-container').classList.add('hidden');
                document.getElementById('file-inputs-container').classList.remove('hidden');
                document.getElementById('photos-only-upload').classList.remove('hidden');
                document.getElementById('photos-and-video-upload').classList.add('hidden');
            });

            const surpriseCheckbox = document.getElementById('surprise-me-checkbox');
            const shortTextArea = document.getElementById('short-text');
            const longTextArea = document.getElementById('long-text');
            surpriseCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                orderState.surpriseMe = isChecked;
                document.getElementById('surprise-me-text').classList.toggle('hidden', !isChecked);
                shortTextArea.disabled = isChecked;
                longTextArea.disabled = isChecked;
                if (isChecked) {
                    shortTextArea.value = '';
                    longTextArea.value = '';
                }
            });

            document.getElementById('to-summary-section').addEventListener('click', async (e) => {
                const button = e.currentTarget;
                const buttonText = document.getElementById('to-summary-btn-text');
                const spinner = document.getElementById('to-summary-btn-spinner');
                const photoInput = orderState.hasVideo ? document.getElementById('photo-input-multi') : document.getElementById('photo-input-only');
                if (photoInput.files.length === 0) {
                    showNotification('Por favor, selecciona al menos una foto.');
                    return;
                }
                
                button.disabled = true;
                spinner.classList.add('hidden'); // Ensure spinner is hidden
                buttonText.textContent = 'Subiendo...';

                try {
                    orderState.shortText = shortTextArea.value.trim();
                    orderState.longText = longTextArea.value.trim();
                    orderState.surpriseMe = surpriseCheckbox.checked;

                    await uploadFilesToFirebase(orderState.orderId);
                    
                    orderState.firebaseFolderUrl = `https://console.firebase.google.com/project/${firebaseConfig.projectId}/storage/${firebaseConfig.storageBucket}/files~2Fpedidos~2F${orderState.orderId}`;
                    
                    showNotification("Archivos subidos con √©xito", false);
                    renderSummary();
                    showSection('summary-section');
                } catch (error) {
                    console.error("Error definitivo en la subida:", error);
                    showNotification("Un error impidi√≥ subir los archivos. Por favor, int√©ntalo de nuevo.");
                } finally {
                    button.disabled = false;
                    buttonText.textContent = 'Subir y continuar';
                    spinner.classList.add('hidden');
                    document.getElementById('progress-container').classList.add('hidden');
                    document.getElementById('progress-bar').style.width = '0%';
                    document.getElementById('progress-text').textContent = ''; // NEW: Reset progress text
                }
            });

            document.getElementById('back-to-upload').addEventListener('click', () => showSection('upload-section'));
            
            document.getElementById('to-payment-section').addEventListener('click', async (e) => {
                const button = e.currentTarget;
                const buttonText = document.getElementById('to-payment-btn-text');
                const spinner = document.getElementById('to-payment-btn-spinner');

                const clientName = document.getElementById('client-name-input').value.trim();
                const clientPhone = document.getElementById('client-phone-input').value.trim();
                const region = document.getElementById('region-select').value;
                const comuna = document.getElementById('comuna-select').value;
                const address = document.getElementById('address-input').value.trim();

                if (!clientName || !clientPhone || !region || !comuna || !address) {
                    showNotification('Por favor, completa todos los campos de despacho.');
                    return;
                }
                
                button.disabled = true;
                spinner.classList.remove('hidden');
                buttonText.textContent = 'Registrando...';

                orderState.clientName = clientName;
                orderState.clientPhone = clientPhone;
                orderState.shipping.region = region;
                orderState.shipping.comuna = comuna;
                orderState.shipping.address = address;

                try {
                    // Guarda el estado del pedido en la sesi√≥n del navegador ANTES de ir a pagar.
                    sessionStorage.setItem('huellitasOrderState', JSON.stringify(orderState));

                    renderPaymentSummary(); 
                    showPaymentDetails();
                    await sendOrderToGoogleSheet();
                    showSection('payment-section');
                } catch (error) {
                    console.error("Error al registrar el pedido en Google Sheets:", error);
                    showNotification("No se pudo registrar tu pedido. Int√©ntalo de nuevo.");
                } finally {
                    button.disabled = false;
                    spinner.classList.add('hidden');
                    buttonText.textContent = 'Continuar al Pago';
                }
            });

            document.getElementById('back-to-summary').addEventListener('click', () => showSection('summary-section'));
            
            // L√≥gica del Modal para ampliar im√°genes
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-img');
            const previewImg = document.getElementById('product-image-preview');
            const closeModalBtn = document.getElementById('close-modal');

            previewImg.addEventListener('click', () => {
                modalImg.src = previewImg.src;
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            });

            const closeModal = () => {
                modal.querySelector('.modal-content').classList.add('scale-95');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // El c√≥digo para el enlace de vista previa ha sido eliminado.

            // Bot√≥n para reiniciar el flujo desde la p√°gina de gracias.
            document.getElementById('start-new-order-btn').addEventListener('click', () => {
                window.location.href = window.location.pathname; 
            });
            
            // --- INICIALIZACI√ìN ---
            populateRegions();
            await loadGallery();
            await loadCategories();
            showSection('home-section');
        });

    </script>
</body>
</html>

