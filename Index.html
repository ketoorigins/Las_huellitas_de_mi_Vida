<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Las Huellitas de mi Vida</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Fredoka -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos base y de diseño inspirados en los requerimientos */
        body {
            background: linear-gradient(135deg, #2b1634, #1f143a);
            font-family: 'Fredoka', sans-serif;
            color: #F0F0F0;
            scroll-behavior: smooth;
        }
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
        }
        .main-button {
            background: linear-gradient(90deg, #4A00E0, #8E2DE2);
            box-shadow: 0 0 15px rgba(142, 45, 226, 0.6);
            transition: all 0.3s ease-in-out;
        }
        .main-button:hover:not(:disabled) {
            box-shadow: 0 0 30px rgba(142, 45, 226, 1);
            transform: translateY(-3px) scale(1.05);
        }
        .main-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 0 15px rgba(142, 45, 226, 0.6);
        }
        .secondary-button {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease-in-out;
        }
        .secondary-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: #00FFFF;
        }
        .category-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .category-card:before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 0.75rem; /* rounded-xl */
            border: 2px solid transparent;
            background: linear-gradient(45deg, #00FFFF, #FF00FF) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: destination-out;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .category-card:hover:before {
            opacity: 1;
        }
        .category-card:hover {
            transform: translateY(-5px);
        }
        .form-input, .form-textarea, .form-select {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #FF00FF;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
            background-color: rgba(0, 0, 0, 0.3);
        }
        .backdrop-blur-md {
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }
        /* Animación para aparición de secciones */
        .section-fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Huellas decorativas de fondo */
        .paw-bg-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .paw-bg-container img {
            position: absolute;
            opacity: 0.2;
            filter: brightness(1.2);
            pointer-events: none;
        }
        /* Estilos para la galería de miniaturas */
        .thumbnail-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease, transform 0.3s ease;
        }
        .thumbnail-image.active {
            border-color: #00FFFF;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="text-[#F0F0F0] antialiased overflow-x-hidden">

    <!-- Huellas Decorativas de Fondo -->
    <div class="paw-bg-container">
        <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella decorativa" style="width: 15%; top: 10%; left: 5%; transform: rotate(-20deg);">
        <img src="https://i.ibb.co/mFSBSN3X/huellas-2.png" alt="huella decorativa" style="width: 10%; top: 20%; right: 10%; transform: rotate(15deg);">
        <img src="https://i.ibb.co/vx7Wb795/huellas.png" alt="huella decorativa" style="width: 8%; bottom: 15%; left: 20%; transform: rotate(30deg);">
        <img src="https://i.ibb.co/ttbd6wP/huellas-4.png" alt="huella decorativa" style="width: 12%; bottom: 5%; right: 15%; transform: rotate(-10deg);">
        <img src="https://i.ibb.co/MDZYf540/huellas-6.png" alt="huella decorativa" style="width: 9%; top: 55%; left: 10%; transform: rotate(5deg);">
        <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella decorativa" style="width: 7%; top: 70%; right: 5%; transform: rotate(25deg);">
    </div>

    <!-- Header Fijo -->
    <header class="fixed top-0 left-0 right-0 z-50">
        <nav class="container mx-auto px-6 py-4 bg-black/20 backdrop-blur-md flex items-center justify-center md:justify-start">
            <img id="header-logo" src="https://i.ibb.co/4R3Rx0Vx/Gemini_Generated_Image-b8hqcvb8hqcvb8hq.png" alt="Logo Las Huellitas de mi Vida" class="h-10 w-10 mr-3 rounded-full">
            <h1 class="text-xl font-bold tracking-wider">Las Huellitas de mi Vida</h1>
        </nav>
    </header>

    <!-- Contenedor Principal de la App -->
    <main id="app-container" class="container mx-auto px-6 pt-28 pb-12 min-h-screen flex flex-col justify-center">

        <!-- PASO 1: Página Principal (Hero) -->
        <section id="home-section" class="text-center section-fade-in">
            <h2 class="text-4xl md:text-5xl font-bold mt-8 mb-4">Cada huella cuenta una historia&nbsp;🐾</h2>
            <p class="text-lg text-gray-300 mb-8 max-w-2xl mx-auto">Transformemos tus recuerdos más preciados en una obra de arte inolvidable.</p>
            <div class="my-8 flex justify-center">
                <img id="hero-image" src="https://i.ibb.co/0jRX3VX2/PORTADA-HUELLitas-3.png" alt="Collage de mascotas" class="max-w-md w-full rounded-2xl shadow-2xl">
            </div>
            <button id="start-project-btn" class="main-button text-white font-bold py-3 px-8 rounded-full text-lg">
                Elige tu Proyecto&nbsp;🐾
            </button>

            <!-- SECCIÓN DE GALERÍA -->
            <div id="gallery-section" class="mt-24">
                <h2 class="text-4xl font-bold mt-8 mb-8">Nuestras Obras Recientes&nbsp;🐾</h2>
                <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-5xl mx-auto">
                    <!-- Las imágenes de la galería se cargarán aquí -->
                </div>
            </div>
        </section>

        <!-- PASO 2: Selección de Categoría -->
        <section id="category-section" class="hidden text-center section-fade-in">
            <h2 class="text-4xl font-bold mt-8 mb-8">¿Qué historia vamos a contar hoy?&nbsp;🐾</h2>
            <div id="category-grid" class="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                <!-- Las categorías se cargarán aquí desde Firebase -->
            </div>
        </section>

        <!-- PASO 3: Formulario Datos de la Mascota -->
        <section id="pet-info-section" class="hidden section-fade-in">
             <div class="max-w-lg mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                <div class="flex justify-center mb-4">
                    <img id="product-image-preview" src="" alt="Producto seleccionado" class="rounded-lg max-h-40 shadow-lg">
                </div>
                <div id="thumbnail-container" class="flex justify-center gap-2 mb-6">
                    <!-- Las miniaturas se generarán aquí con JavaScript -->
                </div>
                <h2 id="pet-info-title" class="text-3xl font-bold text-center mb-6">Datos de tu Mascota</h2>
                <div class="space-y-6">
                    <div>
                        <label for="pet-name" class="block text-sm font-medium text-[#00FFFF] mb-1">Nombre de tu mascota</label>
                        <input type="text" id="pet-name" class="form-input w-full p-3 rounded-lg text-white" placeholder="Ej: Tatán" autocomplete="off">
                    </div>
                    <div>
                        <label for="pet-age" class="block text-sm font-medium text-[#00FFFF] mb-1">Edad (en años humanos)</label>
                        <input type="number" id="pet-age" class="form-input w-full p-3 rounded-lg text-white" placeholder="Ej: 2" autocomplete="off">
                    </div>
                    <div class="flex justify-between items-center pt-4">
                        <button id="back-to-category" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                        <button id="to-upload-section" class="main-button text-white font-bold py-2 px-6 rounded-full">Continuar</button>
                    </div>
                </div>
             </div>
        </section>

        <!-- PASO 4: Formulario Carga de Archivos -->
        <section id="upload-section" class="hidden section-fade-in">
             <div class="max-w-lg mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                <h2 class="text-3xl font-bold text-center mb-6">Ahora, sube tus recuerdos&nbsp;🐾</h2>
            
                <div id="video-choice-container" class="text-center">
                    <p class="text-[#00FFFF] mb-4">¿Incluirás videos en tu homenaje?</p>
                    <div class="flex justify-center gap-4">
                        <button id="has-video-btn" class="main-button font-bold py-3 px-6 rounded-full">Sí, tengo videos&nbsp;🎬</button>
                        <button id="no-video-btn" class="secondary-button font-bold py-3 px-6 rounded-full">No, usaré solo fotos&nbsp;🖼️</button>
                    </div>
                </div>

                <div id="file-inputs-container" class="hidden space-y-6 mt-6">
                    <div id="photos-and-video-upload" class="hidden space-y-4">
                        <div>
                            <label for="photo-input-multi" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga hasta 10 fotos</label>
                            <input type="file" id="photo-input-multi" multiple accept="image/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                        </div>
                        <div>
                            <label for="video-input-multi" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga tus videos</label>
                            <input type="file" id="video-input-multi" multiple accept="video/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                        </div>
                    </div>
                     <div id="photos-only-upload" class="hidden">
                        <label for="photo-input-only" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga hasta 20 fotos</label>
                        <p class="text-xs text-gray-400 mb-2">Con ellas crearemos un video emotivo para el QR de tu obra.</p>
                        <input type="file" id="photo-input-only" multiple accept="image/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                    </div>

                    <div>
                        <label for="short-text" class="block text-sm font-medium text-[#00FFFF] mb-1">Texto Corto (Opcional)</label>
                        <textarea id="short-text" rows="3" class="form-textarea w-full p-3 rounded-lg text-white" placeholder="Una frase o fecha especial..."></textarea>
                    </div>
                    <div>
                        <label for="long-text" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Historia (Opcional)</label>
                        <textarea id="long-text" rows="5" class="form-textarea w-full p-3 rounded-lg text-white" placeholder="Cuéntanos un poco sobre tu amiguito, sus gustos, alguna anécdota..."></textarea>
                    </div>
                    <div class="flex items-center space-x-3 p-3 bg-yellow-900/20 rounded-lg">
                        <input id="surprise-me-checkbox" type="checkbox" class="h-5 w-5 rounded bg-transparent border-yellow-400 text-yellow-500 focus:ring-yellow-600">
                        <label for="surprise-me-checkbox" class="font-bold text-yellow-300">¡Sorpréndeme!&nbsp;🐾</label>
                    </div>
                     <p id="surprise-me-text" class="text-xs text-yellow-400 hidden">Al marcar esta opción, con mucho respeto, empatía y amor, buscaremos el texto adecuado para tu obra.</p>

                    <div class="flex justify-between items-center pt-4">
                        <button id="back-to-pet-info" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                        <button id="to-summary-section" class="main-button text-white font-bold py-2 px-6 rounded-full flex items-center justify-center">
                             <span id="to-summary-btn-text">Subir archivos y continuar</span>
                             <svg id="to-summary-btn-spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                 <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                 <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                             </svg>
                        </button>
                    </div>
                </div>
             </div>
        </section>

        <!-- PASO 5: Resumen y Despacho -->
        <section id="summary-section" class="hidden section-fade-in">
            <div class="max-w-xl mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                <h2 class="text-3xl font-bold text-center mb-6">Revisa tu Pedido</h2>
                <div id="summary-content" class="space-y-4 mb-8 p-4 bg-white/5 rounded-lg">
                    <!-- Contenido del resumen se genera aquí -->
                </div>
                <h3 class="text-2xl font-bold text-center mb-4">Información de Despacho</h3>
                <div id="shipping-form" class="space-y-4">
                    <div>
                        <label for="client-name-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Nombre Completo</label>
                        <input type="text" id="client-name-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="Para el registro del pedido">
                    </div>
                    <div>
                        <label for="client-phone-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Teléfono (WhatsApp)</label>
                        <input type="tel" id="client-phone-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="+56 9 1234 5678">
                    </div>
                    <div>
                        <label for="region-select" class="block text-sm font-medium text-[#00FFFF] mb-1">Región</label>
                        <select id="region-select" class="form-select w-full p-3 rounded-lg text-white"></select>
                    </div>
                    <div>
                        <label for="comuna-select" class="block text-sm font-medium text-[#00FFFF] mb-1">Comuna</label>
                        <select id="comuna-select" class="form-select w-full p-3 rounded-lg text-white"></select>
                    </div>
                    <div>
                        <label for="address-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Dirección</label>
                        <input type="text" id="address-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="Calle, número, depto/casa">
                    </div>
                </div>
                 <div class="flex justify-between items-center pt-6">
                    <button id="back-to-upload" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                    <button id="to-payment-section" class="main-button text-white font-bold py-2 px-6 rounded-full">
                        Continuar al Pago
                    </button>
                </div>
            </div>
        </section>

        <!-- PASO 6: Pago Y CONFIRMACIÓN FINAL -->
        <section id="payment-section" class="hidden section-fade-in">
            <div class="max-w-xl mx-auto bg-black/20 p-8 rounded-xl border border-white/10 text-center">
                <h2 class="text-3xl font-bold mb-2">¡Estás a un paso de terminar!</h2>
                <p class="text-gray-300 mb-6">Realiza tu pago a través de los siguientes medios. Una vez listo, vuelve y presiona "Finalizar Compra" para enviarnos tu comprobante.</p>
                <div id="payment-details" class="grid md:grid-cols-2 gap-8 items-center">
                    <div class="flex flex-col items-center">
                        <h3 class="text-xl font-bold mb-2 text-[#00FFFF]">Paga con QR Mercado Pago</h3>
                        <div id="qr-code-container" class="bg-white p-2 rounded-lg h-48 w-48 flex items-center justify-center text-center">
                            <!-- QR se carga aquí -->
                        </div>
                    </div>
                    <div id="transfer-details-container" class="text-left bg-white/5 p-4 rounded-lg">
                        <h3 class="text-xl font-bold mb-3 text-[#00FFFF]">Datos para Transferencia</h3>
                        <!-- Datos de transferencia se cargan aquí -->
                    </div>
                </div>
                <div class="mt-8">
                    <p class="text-2xl font-bold">MONTO TOTAL: <span id="total-amount" class="text-green-400"></span></p>
                </div>
                <div class="mt-8">
                    <button id="finish-purchase-btn" class="main-button inline-flex items-center justify-center text-white font-bold py-3 px-8 rounded-full text-lg w-full md:w-auto">
                        <span id="finish-purchase-btn-text">Finalizar Compra y Enviar Comprobante</span>
                    </button>
                </div>
                 <div class="mt-6">
                    <button id="back-to-summary" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                </div>
            </div>
        </section>

    </main>

    <!-- Notificación Toast -->
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-red-500 text-white py-3 px-6 rounded-full shadow-lg text-center z-[100] opacity-0 transition-all duration-300">
        <p id="toast-message"></p>
    </div>
    
    <script type="module">
        // --- IMPORTS DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadString, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDR42aJIpDkXL5T2vgj-J2ceZFVZCqzCms",
            authDomain: "las-huellitas-de-mi-vida.firebaseapp.com",
            projectId: "las-huellitas-de-mi-vida",
            storageBucket: "las-huellitas-de-mi-vida.appspot.com",
            messagingSenderId: "1095265611249",
            appId: "1:1095265611249:web:09930aaef56d0736bea850",
            measurementId: "G-0QB83X7TBC"
        };

        // --- INICIALIZACIÓN DE SERVICIOS ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // --- ESTADO GLOBAL DE LA APLICACIÓN ---
        const orderState = {
            category: '', basePrice: 0, imageUrls: [], petName: '', petAge: '',
            clientName: '', clientPhone: '', orderId: '', shortText: '', longText: '',
            surpriseMe: false, shipping: { region: '', comuna: '', address: '', cost: 0, },
            firebaseFolderUrl: '', hasVideo: null,
        };

        let paymentConfig = {}; 
        
        // --- CONSTANTES ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxUFrThwhSwv6MyAG_hjGeeRcNPP8d80TLIYmZXo4U7JI1IDlvBt4QmBouveySlLNJbyA/exec'; 
        
        // --- FUNCIONES UTILITARIAS ---
        const sections = document.querySelectorAll('main > section');
        
        function showSection(sectionId) {
            sections.forEach(section => section.classList.add('hidden'));
            document.getElementById(sectionId)?.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function showNotification(message, isError = true) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'opacity-0');
            toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 5000);
        }
        
        async function loadCollection(collectionName, targetElementId, renderer) {
            const grid = document.getElementById(targetElementId);
            grid.innerHTML = `<p class="text-center col-span-full">Cargando...</p>`;
            try {
                const querySnapshot = await getDocs(collection(db, collectionName));
                if (querySnapshot.empty) {
                    grid.innerHTML = `<p class="text-yellow-400 text-center col-span-full">No hay contenido disponible.</p>`;
                    return;
                }
                grid.innerHTML = ''; 
                querySnapshot.forEach((doc) => grid.innerHTML += renderer(doc.data(), doc.id));
                return true;
            } catch (error) {
                console.error(`Error loading ${collectionName}:`, error);
                grid.innerHTML = `<p class="text-red-500 text-center col-span-full">No se pudo cargar el contenido. Revisa la conexión con Firebase.</p>`;
                return false;
            }
        }

        function generateOrderId() {
            const prefix = "HUELLITAS";
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let result = "";
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return `${prefix}-${result}`;
        }
        
        // --- LÓGICA DE NEGOCIO (SUBIDAS, ENVÍOS) ---
        async function uploadFilesToFirebase(orderId) {
            const photoInput = orderState.hasVideo ? document.getElementById('photo-input-multi') : document.getElementById('photo-input-only');
            const videoInput = orderState.hasVideo ? document.getElementById('video-input-multi') : null;

            const filesToUpload = [...photoInput.files];
            if (videoInput && videoInput.files.length > 0) {
                filesToUpload.push(...videoInput.files);
            }

            const textFiles = [];
            if (!orderState.surpriseMe) {
                if (orderState.shortText) textFiles.push({ name: 'texto_corto.txt', content: orderState.shortText });
                if (orderState.longText) textFiles.push({ name: 'historia.txt', content: orderState.longText });
            }
            
            const allPromises = [];

            filesToUpload.forEach(file => {
                const fileRef = ref(storage, `pedidos/${orderId}/${file.name}`);
                allPromises.push(uploadBytes(fileRef, file));
            });

            textFiles.forEach(textFile => {
                const textRef = ref(storage, `pedidos/${orderId}/${textFile.name}`);
                allPromises.push(uploadString(textRef, textFile.content));
            });
            
            await Promise.all(allPromises);
        }
        
        async function sendOrderToGoogleSheet() {
            const formData = new FormData();
            formData.append('Timestamp', new Date().toISOString());
            formData.append('ID de Pedido', orderState.orderId);
            formData.append('Categoria', orderState.category);
            formData.append('Nombre Mascota', orderState.petName);
            formData.append('Edad Mascota', orderState.petAge);
            formData.append('Nombre Cliente', orderState.clientName || '');
            formData.append('Dirección', `${orderState.shipping.address}, ${orderState.shipping.comuna}, ${orderState.shipping.region}`);
            formData.append('Telefono', orderState.clientPhone || '');
            formData.append('Costo Envio', orderState.shipping.cost);
            formData.append('Total Pagado', orderState.basePrice + orderState.shipping.cost);
            formData.append('Texto Corto', orderState.surpriseMe ? '¡Sorpréndeme!' : orderState.shortText);
            formData.append('Historia', orderState.surpriseMe ? '¡Sorpréndeme!' : orderState.longText);
            formData.append('Enlace a Archivos', orderState.firebaseFolderUrl);

            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            const locations = { "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"], "Tarapacá": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Camiña", "Colchane", "Huara", "Pica"], "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollagüe", "San Pedro de Atacama", "Tocopilla", "María Elena"], "Atacama": ["Copiapó", "Caldera", "Tierra Amarilla", "Chañaral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"], "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicuña", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbalá", "Monte Patria", "Punitaqui", "Río Hurtado"], "Valparaíso": ["Valparaíso", "Casablanca", "Concón", "Juan Fernández", "Puchuncaví", "Quintero", "Viña del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa María", "Quilpué", "Limache", "Olmué", "Villa Alemana"], "Metropolitana de Santiago": ["Santiago", "Cerrillos", "Cerro Navia", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maipú", "Ñuñoa", "Pedro Aguirre Cerda", "Peñalolén", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaquín", "San Miguel", "San Ramón", "Vitacura", "Puente Alto", "Pirque", "San José de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhué", "Curacaví", "María Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Peñaflor"], "O'Higgins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Doñihue", "Graneros", "Las Cabras", "Machalí", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requínoa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Chépica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"], "Maule": ["Talca", "Constitución", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "Río Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curicó", "Hualañé", "Licantén", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuquén", "Linares", "Colbún", "Longaví", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"], "Ñuble": ["Chillán", "Bulnes", "Chillán Viejo", "El Carmen", "Pemuco", "Pinto", "Quillón", "San Ignacio", "Yungay", "Quirihue", "Cobquecura", "Coelemu", "Ninhue", "Portezuelo", "Ránquil", "Treguaco", "San Carlos", "Coihueco", "Ñiquén", "San Fabián", "San Nicolás"], "Biobío": ["Concepción", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tomé", "Hualpén", "Lebu", "Arauco", "Cañete", "Contulmo", "Curanilahue", "Los Álamos", "Tirúa", "Los Ángeles", "Antuco", "Cabrero", "Laja", "Mulchén", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa Bárbara", "Tucapel", "Yumbel", "Alto Biobío"], "Araucanía": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre las Casas", "Perquenco", "Pitrufquén", "Pucón", "Saavedra", "Teodoro Schmidt", "Toltén", "Vilcún", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacautín", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Purén", "Renaico", "Traiguén", "Victoria"], "Los Ríos": ["Valdivia", "Corral", "Lanco", "Los Lagos", "Máfil", "Mariquina", "Paillaco", "Panguipulli", "La Unión", "Futrono", "Lago Ranco", "Río Bueno"], "Los Lagos": ["Puerto Montt", "Calbuco", "Cochamó", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maullín", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de Vélez", "Dalcahue", "Puqueldón", "Queilén", "Quellón", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "Río Negro", "San Juan de la Costa", "San Pablo", "Chaitén", "Futaleufú", "Hualaihué", "Palena"], "Aysén": ["Coyhaique", "Lago Verde", "Aysén", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "Río Ibáñez"], "Magallanes": ["Punta Arenas", "Laguna Blanca", "Río Verde", "San Gregorio", "Cabo de Hornos (Ex Navarino)", "Antártica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]
            };
            const regionSelect = document.getElementById('region-select');
            const comunaSelect = document.getElementById('comuna-select');
            
            function populateRegions() {
                regionSelect.innerHTML = '<option value="">Selecciona una Región</option>';
                Object.keys(locations).sort().forEach(region => regionSelect.add(new Option(region, region)));
            }
            regionSelect.addEventListener('change', () => {
                comunaSelect.innerHTML = '<option value="">Selecciona una Comuna</option>';
                const comunas = locations[regionSelect.value] || [];
                comunas.sort().forEach(comuna => comunaSelect.add(new Option(comuna, comuna)));
            });

            // --- FUNCIONES DE RENDERIZADO DINÁMICO ---
            function renderSummary() {
                document.getElementById('summary-content').innerHTML = `
                    <p><strong>Categoría:</strong> ${orderState.category}</p>
                    <p><strong>Mascota:</strong> ${orderState.petName}, ${orderState.petAge} años</p>
                    <p><strong>ID de Pedido:</strong> ${orderState.orderId}</p>
                    <p><strong>Textos:</strong> ${orderState.surpriseMe ? '¡Sorpréndeme! Equipo elegirá los textos.' : 'Personalizados.'}</p>
                    <p><strong>Archivos:</strong> <a href="${orderState.firebaseFolderUrl}" target="_blank" class="text-cyan-400 underline hover:text-cyan-300">Ver Carpeta de Archivos</a></p>
                `;
            }

            function showPaymentDetails() {
                const qrContainer = document.getElementById('qr-code-container');
                const transferDetailsContainer = document.getElementById('transfer-details-container');
                const comuna = orderState.shipping.comuna;
                const comunasAledanas = ['Machalí', 'Graneros', 'Olivar', 'Doñihue', 'Requínoa', 'Codegua', 'Mostazal', 'Coinco', 'Coltauco', 'Rengo'];
                let qrUrlKey = 'qrUrlRegiones';
                orderState.shipping.cost = 8000;
                if (comuna === 'Rancagua') { qrUrlKey = 'qrUrlRancagua'; orderState.shipping.cost = 0; }
                else if (comunasAledanas.includes(comuna)) { qrUrlKey = 'qrUrlAfueras'; orderState.shipping.cost = 5000; }
                
                document.getElementById('total-amount').textContent = `$${(orderState.basePrice + orderState.shipping.cost).toLocaleString('es-CL')}`;
                
                qrContainer.innerHTML = '';
                transferDetailsContainer.innerHTML = '<h3 class="text-xl font-bold mb-3 text-[#00FFFF]">Datos para Transferencia</h3>';

                const qrUrl = paymentConfig[qrUrlKey];
                if (qrUrl) {
                    qrContainer.innerHTML = `<a href="${qrUrl}" target="_blank" title="Abrir QR en nueva pestaña"><img src="${qrUrl}" alt="Código QR de Mercado Pago" class="h-full w-full object-contain"></a>`;
                } else {
                    qrContainer.innerHTML = `<p class="text-xs text-red-500 p-2">QR no disponible.</p>`;
                }

                transferDetailsContainer.innerHTML += `
                    <p class="text-sm"><strong>Banco:</strong> ${paymentConfig.bank || '[No disponible]'}</p>
                    <p class="text-sm"><strong>Tipo de Cuenta:</strong> ${paymentConfig.accountType || '[No disponible]'}</p>
                    <p class="text-sm"><strong>Nº de Cuenta:</strong> ${paymentConfig.accountNumber || '[No disponible]'}</p>
                    <p class="text-sm"><strong>Nombre:</strong> ${paymentConfig.name || '[No disponible]'}</p>
                    <p class="text-sm"><strong>RUT:</strong> ${paymentConfig.rut || '[No disponible]'}</p>
                    <p class="text-sm"><strong>Email:</strong> ${paymentConfig.email || '[No disponible]'}</p>
                `;
            }

            // --- EVENT LISTENERS (MANEJO DE LA INTERFAZ) ---
            document.getElementById('start-project-btn').addEventListener('click', () => showSection('category-section'));
            document.getElementById('back-to-category').addEventListener('click', () => showSection('category-section'));
            
            document.getElementById('to-upload-section').addEventListener('click', () => {
                const petName = document.getElementById('pet-name').value.trim();
                const petAge = document.getElementById('pet-age').value.trim();
                if (!petName || !petAge) {
                    showNotification('Por favor, completa nombre y edad.');
                    return;
                }
                orderState.petName = petName;
                orderState.petAge = petAge;
                if (!orderState.orderId) { // Generar ID solo si no existe
                    orderState.orderId = generateOrderId();
                }
                showSection('upload-section');
            });

            document.getElementById('back-to-pet-info').addEventListener('click', () => showSection('pet-info-section'));
            
            document.getElementById('has-video-btn').addEventListener('click', () => {
                orderState.hasVideo = true;
                document.getElementById('video-choice-container').classList.add('hidden');
                document.getElementById('file-inputs-container').classList.remove('hidden');
                document.getElementById('photos-and-video-upload').classList.remove('hidden');
                document.getElementById('photos-only-upload').classList.add('hidden');
            });
            document.getElementById('no-video-btn').addEventListener('click', () => {
                orderState.hasVideo = false;
                document.getElementById('video-choice-container').classList.add('hidden');
                document.getElementById('file-inputs-container').classList.remove('hidden');
                document.getElementById('photos-only-upload').classList.remove('hidden');
                document.getElementById('photos-and-video-upload').classList.add('hidden');
            });

            const surpriseCheckbox = document.getElementById('surprise-me-checkbox');
            const shortTextArea = document.getElementById('short-text');
            const longTextArea = document.getElementById('long-text');
            surpriseCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                orderState.surpriseMe = isChecked;
                document.getElementById('surprise-me-text').classList.toggle('hidden', !isChecked);
                shortTextArea.disabled = isChecked;
                longTextArea.disabled = isChecked;
                if (isChecked) {
                    shortTextArea.value = '';
                    longTextArea.value = '';
                }
            });

            document.getElementById('to-summary-section').addEventListener('click', async (e) => {
                const button = e.currentTarget;
                const buttonText = document.getElementById('to-summary-btn-text');
                const spinner = document.getElementById('to-summary-btn-spinner');
                const photoInput = orderState.hasVideo ? document.getElementById('photo-input-multi') : document.getElementById('photo-input-only');
                if (photoInput.files.length === 0) {
                    showNotification('Por favor, selecciona al menos una foto.');
                    return;
                }
                
                button.disabled = true;
                spinner.classList.remove('hidden');
                buttonText.textContent = 'Subiendo...';

                try {
                    orderState.shortText = shortTextArea.value;
                    orderState.longText = longTextArea.value;
                    orderState.surpriseMe = surpriseCheckbox.checked;

                    await uploadFilesToFirebase(orderState.orderId);
                    
                    orderState.firebaseFolderUrl = `https://console.firebase.google.com/project/${firebaseConfig.projectId}/storage/${firebaseConfig.storageBucket}/files~2Fpedidos~2F${orderState.orderId}`;
                    
                    showNotification("Archivos subidos con éxito", false);
                    renderSummary();
                    showSection('summary-section');
                } catch (error) {
                    console.error("Error en la subida de archivos:", error);
                    let errorMessage = "Un error impidió subir los archivos. Por favor, inténtalo de nuevo.";
                    if (error.code === 'storage/unauthorized') {
                        errorMessage = "ERROR DE PERMISOS: Firebase está bloqueando la subida. Revisa las Reglas de Storage.";
                    }
                    showNotification(errorMessage);
                } finally {
                    button.disabled = false;
                    buttonText.textContent = 'Subir archivos y continuar';
                    spinner.classList.add('hidden');
                }
            });

            document.getElementById('back-to-upload').addEventListener('click', () => showSection('upload-section'));
            
            document.getElementById('to-payment-section').addEventListener('click', async () => {
                const clientName = document.getElementById('client-name-input').value.trim();
                const clientPhone = document.getElementById('client-phone-input').value.trim();
                const region = document.getElementById('region-select').value;
                const comuna = document.getElementById('comuna-select').value;
                const address = document.getElementById('address-input').value.trim();

                let missingField = '';
                if (!clientName) missingField = 'Nombre';
                else if (!clientPhone) missingField = 'Teléfono';
                else if (!region) missingField = 'Región';
                else if (!comuna) missingField = 'Comuna';
                else if (!address) missingField = 'Dirección';

                if (missingField) {
                    showNotification(`Por favor, completa el campo: ${missingField}.`);
                    return;
                }

                orderState.clientName = clientName;
                orderState.clientPhone = clientPhone;
                orderState.shipping.region = region;
                orderState.shipping.comuna = comuna;
                orderState.shipping.address = address;

                try {
                    await sendOrderToGoogleSheet();
                    showPaymentDetails();
                    showSection('payment-section');
                } catch (error) {
                    console.error("Error al registrar el pedido en Google Sheets:", error);
                    showNotification("No se pudo registrar tu pedido. Inténtalo de nuevo.");
                }
            });

            document.getElementById('back-to-summary').addEventListener('click', () => showSection('summary-section'));
            
            document.getElementById('finish-purchase-btn').addEventListener('click', () => {
                const whatsappNumber = '56946902340'; // Reemplazar con tu número
                const message = encodeURIComponent(`¡Hola! Te contacto desde "Las Huellitas de mi Vida" para enviar mi comprobante de pago por el pedido de ${orderState.petName}. (ID: ${orderState.orderId}) 🐾`);
                const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${message}`;
                window.open(whatsappUrl, '_blank');
            });
            
            // --- INICIALIZACIÓN DE LA APLICACIÓN ---
            try {
                const docRef = doc(db, "config", "paymentMethods");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    paymentConfig = docSnap.data();
                } else {
                    console.warn("Documento de métodos de pago no encontrado en Firestore.");
                }
            } catch(e) {
                console.error("Error al cargar configuración de pago:", e);
                showNotification("No se pudo cargar la info de pago.");
            }

            populateRegions();
            await loadCollection("gallery", "gallery-grid", (data) => `<div class="rounded-lg overflow-hidden shadow-lg aspect-square"><img src="${data.imageUrl}" alt="Obra de arte de mascota" class="w-full h-full object-cover"></div>`);
            const categoriesLoaded = await loadCollection("categories", "category-grid", (data) => `
                <div class="category-card rounded-xl cursor-pointer flex flex-col text-center" 
                     data-category='${JSON.stringify(data)}'>
                    <div class="p-6 flex flex-col flex-grow items-center">
                        <div class="text-6xl mb-4">${data.icon || '🐾'}</div>
                        <h3 class="text-xl font-bold mb-1">${data.name}</h3>
                        <p class="text-gray-400 text-xs mb-2">${data.size}</p>
                        <p class="text-gray-300 text-sm flex-grow mb-4">${data.description}</p>
                        <p class="text-2xl font-bold mt-auto text-green-400">$${(data.price || 0).toLocaleString('es-CL')}</p>
                    </div>
                </div>`);
            if (categoriesLoaded) {
                document.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const data = JSON.parse(e.currentTarget.dataset.category);
                        orderState.category = data.name;
                        orderState.basePrice = data.price;
                        orderState.imageUrls = data.imageUrls || [];
                        const preview = document.getElementById('product-image-preview');
                        const thumbs = document.getElementById('thumbnail-container');
                        thumbs.innerHTML = '';
                        if (orderState.imageUrls.length > 0) {
                            preview.src = orderState.imageUrls[0];
                            orderState.imageUrls.forEach((url, index) => {
                                const thumb = document.createElement('img');
                                thumb.src = url;
                                thumb.className = 'thumbnail-image' + (index === 0 ? ' active' : '');
                                thumb.onclick = () => {
                                    preview.src = url;
                                    document.querySelectorAll('.thumbnail-image').forEach(t => t.classList.remove('active'));
                                    thumb.classList.add('active');
                                };
                                thumbs.appendChild(thumb);
                            });
                        } else {
                            preview.src = 'https://placehold.co/400x300/333/FFF?text=Sin+Imagen';
                        }
                        document.getElementById('pet-info-title').textContent = `Proyecto: ${orderState.category}`;
                        showSection('pet-info-section');
                    });
                });
            }
            showSection('home-section');
        });

    </script>
</body>
</html>

