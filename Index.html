<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Las Huellitas de mi Vida</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Fredoka -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos base y de diseño especificados en el Prompt Maestro */
        body {
            background: linear-gradient(135deg, #2b1634, #1f143a);
            font-family: 'Fredoka', sans-serif;
            color: #F0F0F0;
            scroll-behavior: smooth;
        }
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
        }
        .main-button {
            background: linear-gradient(90deg, #8E2DE2, #4A00E0);
            box-shadow: 0 0 15px rgba(142, 45, 226, 0.6);
            transition: all 0.3s ease-in-out;
        }
        .main-button:hover:not(:disabled) {
            box-shadow: 0 0 30px rgba(142, 45, 226, 1);
            transform: translateY(-3px) scale(1.05);
        }
        .main-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .secondary-button {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease-in-out;
        }
        .secondary-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: #00FFFF;
        }
        .category-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .category-card:before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 0.75rem; /* rounded-xl */
            border: 2px solid transparent;
            background: linear-gradient(45deg, #00FFFF, #FF00FF) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: destination-out;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .category-card:hover:before {
            opacity: 1;
        }
        .category-card:hover {
            transform: translateY(-5px);
        }
        .form-input, .form-textarea, .form-select {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #FF00FF;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
            background-color: rgba(0, 0, 0, 0.3);
        }
        .backdrop-blur-md {
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }
        .section-fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .paw-bg-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .paw-bg-container img {
            position: absolute;
            opacity: 0.2;
            filter: brightness(1.2);
        }
        .thumbnail-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }
        .thumbnail-image.active {
            border-color: #00FFFF;
        }
        .gallery-image-hover {
            transition: transform 0.3s ease-in-out;
        }
        .gallery-image-hover:hover {
            transform: scale(1.05);
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .gradient-divider {
            height: 2px;
            border: 0;
            background: linear-gradient(90deg, transparent, #8E2DE2, #4A00E0, transparent);
        }
        .mercadopago-button {
            transition: all 0.3s ease-in-out !important;
            box-shadow: 0 4px 15px rgba(0, 129, 255, 0.4) !important;
            transform: scale(1.1); /* Hacemos el botón un 10% más grande */
        }
        .mercadopago-button:hover {
            box-shadow: 0 6px 25px rgba(0, 129, 255, 0.6) !important;
            transform: scale(1.15); /* Un poco más grande al pasar el mouse */
        }
        /* Estilos para el carrusel de la galería principal */
        .gallery-carousel {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch; /* Para un desplazamiento suave en iOS */
            scrollbar-width: none; /* Ocultar barra de scroll en Firefox */
        }
        .gallery-carousel::-webkit-scrollbar {
            display: none; /* Ocultar barra de scroll en Chrome, Safari, Edge */
        }
        .gallery-carousel-item {
            flex: 0 0 50%; /* En móvil, muestra 2 imágenes */
            scroll-snap-align: center;
            padding: 0 0.5rem;
        }
        @media (min-width: 768px) {
            .gallery-carousel-item {
                flex: 0 0 25%; /* En escritorio, muestra 4 imágenes */
            }
        }
        /* --- ESTILOS PARA LA ANIMACIÓN DE MASCOTAS EN MÓVIL --- */
        .peeking-animal {
            transition: transform 0.8s ease-in-out;
        }
        .peeking-animal.hide-mobile-animation {
            transform: translateY(100%);
        }
        /* --- ESTILOS PARA EL BOTÓN FLOTANTE DE WHATSAPP --- */
        .whatsapp-float-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: #25D366;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(37, 211, 102, 0.7);
            z-index: 50;
            transition: all 0.3s ease;
        }
        .whatsapp-float-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(37, 211, 102, 1);
        }
    </style>
</head>
<body class="antialiased overflow-x-hidden">

    <!-- Mascotas asomándose -->
    <img id="peeking-dog" src="https://i.ibb.co/DfH4TPB8/Dise-o-sin-t-tulo-7.png" alt="Cachorro asomándose" class="peeking-animal hidden fixed bottom-0 left-0 w-40 md:w-56 z-40">
    <img id="peeking-cat" src="https://i.ibb.co/spPvfb9H/Dise-o-sin-t-tulo-6.png" alt="Gato asomándose" class="peeking-animal hidden fixed bottom-0 right-0 w-40 md:w-56 z-40">
    <img id="peeking-family" src="https://i.ibb.co/7dRW4ZMY/Dise-o-sin-t-tulo-9.png" alt="Familia de mascotas asomándose" class="peeking-animal hidden fixed bottom-0 left-0 w-40 md:w-56 z-40">

    <!-- Huellas Decorativas de Fondo -->
    <div class="paw-bg-container">
        <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella" style="width: 15%; top: 10%; left: 5%; transform: rotate(-20deg);">
        <img src="https://i.ibb.co/mFSBSN3X/huellas-2.png" alt="huella" style="width: 10%; top: 20%; right: 10%; transform: rotate(15deg);">
        <img src="https://i.ibb.co/vx7Wb795/huellas.png" alt="huella" style="width: 8%; bottom: 15%; left: 20%; transform: rotate(30deg);">
        <img src="https://i.ibb.co/ttbd6wP/huellas-4.png" alt="huella" style="width: 12%; bottom: 5%; right: 15%; transform: rotate(-10deg);">
        <img src="https://i.ibb.co/MDZYf540/huellas-6.png" alt="huella" style="width: 9%; top: 55%; left: 10%; transform: rotate(5deg);">
        <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella" style="width: 7%; top: 70%; right: 5%; transform: rotate(25deg);">
    </div>

    <!-- Header Fijo -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-black/20 backdrop-blur-md h-20">
        <div class="w-full h-full px-6 flex justify-center items-center md:grid md:grid-cols-3">
            <div class="hidden md:flex items-center gap-x-4 justify-self-start">
                 <img src="https://i.ibb.co/MDZYf540/huellas-6.png" alt="huella" class="h-7 transform rotate-45">
                 <img src="https://i.ibb.co/ttbd6wP/huellas-4.png" alt="huella" class="h-7 transform rotate-25">
                 <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella" class="h-7 transform -rotate-12">
                 <img src="https://i.ibb.co/mFSBSN3X/huellas-2.png" alt="huella" class="h-7 transform rotate-15">
                 <img src="https://i.ibb.co/vx7Wb795/huellas.png" alt="huella" class="h-7 transform -rotate-25">
            </div>
            <div class="flex items-center justify-self-center">
                <img id="header-logo" src="https://i.ibb.co/4R3Rx0Vx/Gemini_Generated_Image-b8hqcvb8hqcvb8hq.png" alt="Logo" class="h-10 w-10 mr-4 rounded-full flex-shrink-0">
                <h1 class="text-2xl md:text-3xl font-bold tracking-wider text-center whitespace-nowrap">Las Huellitas de mi Vida</h1>
            </div>
            <div class="hidden md:flex items-center gap-x-4 justify-self-end">
                 <img src="https://i.ibb.co/vx7Wb795/huellas.png" alt="huella" class="h-7 transform -rotate-15">
                 <img src="https://i.ibb.co/ttbd6wP/huellas-4.png" alt="huella" class="h-7 transform rotate-12">
                 <img src="https://i.ibb.co/MDZYf540/huellas-6.png" alt="huella" class="h-7 transform rotate-30">
                 <img src="https://i.ibb.co/Z1J9YXq9/huellas-1.png" alt="huella" class="h-7 transform -rotate-25">
                 <img src="https://i.ibb.co/mFSBSN3X/huellas-2.png" alt="huella" class="h-7 transform rotate-45">
            </div>
        </div>
    </header>

    <!-- Modal para ver imagen en grande -->
    <div id="image-modal" class="modal-overlay hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 opacity-0">
        <div class="modal-content relative max-w-3xl max-h-[90vh] transform scale-95">
            <img id="modal-img" src="" alt="Vista ampliada" class="w-full h-full object-contain rounded-lg">
            <button id="close-modal" class="absolute -top-4 -right-4 h-10 w-10 bg-white text-black rounded-full text-2xl font-bold">&times;</button>
        </div>
    </div>

    <!-- Contenedor Principal de la App -->
    <main id="app-container" class="container mx-auto px-6 pt-28 pb-12 min-h-screen flex flex-col justify-center">

        <!-- PASO 1: Página Principal (Hero) -->
        <section id="home-section" class="text-center section-fade-in">
            <h2 class="text-4xl md:text-5xl font-bold mt-8 mb-4">Cada huella cuenta una historia&nbsp;🐾</h2>
            <p class="text-xl text-gray-300 mb-8 max-w-2xl mx-auto">Transformemos tus recuerdos más preciados en una obra de arte inolvidable.</p>
            <div class="my-8 flex justify-center">
                <img id="hero-image" src="https://i.ibb.co/0jRX3VX2/PORTADA-HUELLitas-3.png" alt="Collage de mascotas" class="max-w-2xl w-full rounded-2xl shadow-2xl">
            </div>
            <button id="start-project-btn" class="main-button text-white font-bold py-3 px-8 rounded-full text-lg">
                Elige tu Proyecto&nbsp;🐾
            </button>

            <!-- SECCIÓN DE GALERÍA -->
            <div id="gallery-container" class="mt-24">
                <!-- IMAGEN CIRCULAR RESTAURADA -->
                <div class="flex justify-center mb-8">
                    <div class="w-full max-w-md md:max-w-xl aspect-square rounded-full bg-cover bg-center bg-no-repeat" style="background-image: url('https://i.ibb.co/4R3Rx0Vx/Gemini_Generated_Image-b8hqcvb8hqcvb8hq.png')">
                    </div>
                </div>
                 <h2 class="text-4xl font-bold mb-8">Nuestros Diseños&nbsp;🐾</h2>
                 <div class="relative max-w-5xl mx-auto">
                     <div id="gallery-grid" class="gallery-carousel">
                         <!-- Las imágenes de la galería se cargarán aquí -->
                     </div>
                     <!-- Botones de Navegación del Carrusel -->
                     <button id="gallery-prev" class="absolute top-1/2 left-0 transform -translate-y-1/2 -translate-x-8 bg-black/30 text-white rounded-full h-12 w-12 flex items-center justify-center text-2xl hover:bg-black/50 transition duration-300 hidden md:flex">&lt;</button>
                     <button id="gallery-next" class="absolute top-1/2 right-0 transform -translate-y-1/2 translate-x-8 bg-black/30 text-white rounded-full h-12 w-12 flex items-center justify-center text-2xl hover:bg-black/50 transition duration-300 hidden md:flex">&gt;</button>
                 </div>
            </div>
        </section>

        <!-- PASO 2: Selección de Categoría -->
        <section id="category-section" class="hidden text-center section-fade-in">
            <h2 class="text-4xl font-bold mt-8 mb-8">¿Qué historia vamos a contar hoy?&nbsp;🐾</h2>
            <div id="category-grid" class="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                <!-- Las categorías se cargarán aquí desde Firebase -->
            </div>
        </section>
        
        <!-- PASO 3: Formulario Datos de la Mascota -->
        <section id="pet-info-section" class="hidden section-fade-in flex justify-center items-center">
            <!-- Contenedor principal que se ajusta dinámicamente -->
            <div id="pet-info-layout-container" class="w-full max-w-6xl grid md:grid-cols-2 gap-8 items-center">
                
                <!-- Columna del Formulario -->
                <div id="pet-form-container" class="bg-black/20 p-8 rounded-xl border border-white/10">
                    <div class="flex justify-center mb-4">
                        <img id="product-image-preview" src="" alt="Producto seleccionado" class="rounded-lg max-h-40 shadow-lg cursor-pointer transition-transform duration-300 hover:scale-105">
                    </div>
                    <div id="thumbnail-container" class="flex justify-center gap-2 mb-6">
                        <!-- Las miniaturas se generarán aquí con JavaScript -->
                    </div>
                    <h2 id="pet-info-title" class="text-3xl font-bold text-center mb-6">Datos de tu Mascota</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="pet-name" class="block text-sm font-medium text-[#00FFFF] mb-1">Nombre de tu mascota</label>
                            <input type="text" id="pet-name" class="form-input w-full p-3 rounded-lg text-white" placeholder="Ej: Tatán" autocomplete="off">
                        </div>
                        <div>
                            <label for="pet-age" class="block text-sm font-medium text-[#00FFFF] mb-1">Edad (en años humanos)</label>
                            <input type="number" id="pet-age" class="form-input w-full p-3 rounded-lg text-white" placeholder="Ej: 2" autocomplete="off">
                        </div>
                        <div class="flex justify-between items-center pt-4">
                            <button id="back-to-category" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                            <button id="to-upload-section" class="main-button text-white font-bold py-2 px-6 rounded-full">Continuar</button>
                        </div>
                    </div>
                </div>

                <!-- Columna de Descripción Poética -->
                <div id="pet-description-container" class="p-4 md:p-8">
                    <!-- El contenido se inyecta aquí con JavaScript -->
                </div>
            </div>
        </section>

        <!-- PASO 4: Formulario Carga de Archivos -->
        <section id="upload-section" class="hidden section-fade-in">
            <div class="max-w-lg mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                <h2 class="text-3xl font-bold text-center mb-6">Ahora, sube tus recuerdos&nbsp;🐾</h2>
                
                <div class="p-4 mb-6 bg-cyan-900/50 border border-cyan-500 rounded-lg text-center">
                    <p class="text-cyan-200 text-sm">📶 Para una subida más rápida, te recomendamos conectarte a una red Wi-Fi.</p>
                </div>

                <div id="video-choice-container" class="text-center">
                    <p class="text-[#00FFFF] mb-4">¿Incluirás videos en tu homenaje?</p>
                    <div class="flex justify-center gap-4">
                        <button id="has-video-btn" class="main-button font-bold py-3 px-6 rounded-full">Sí, tengo videos&nbsp;🎬</button>
                        <button id="no-video-btn" class="secondary-button font-bold py-3 px-6 rounded-full">No, usaré solo fotos&nbsp;🖼️</button>
                    </div>
                </div>

                <div id="file-inputs-container" class="hidden space-y-6 mt-6">
                    <div id="photos-and-video-upload" class="hidden space-y-4">
                        <div>
                            <label for="photo-input-multi" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga tus fotos</label>
                            <input type="file" id="photo-input-multi" multiple accept="image/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                        </div>
                        <div>
                            <label for="video-input-multi" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga tus videos</label>
                            <input type="file" id="video-input-multi" multiple accept="video/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                        </div>
                    </div>
                    <div id="photos-only-upload" class="hidden">
                        <label for="photo-input-only" class="block text-sm font-medium text-[#00FFFF] mb-2">Carga tus fotos</label>
                        <p class="text-xs text-gray-400 mb-2">Con ellas crearemos un video emotivo para el QR de tu obra.</p>
                        <input type="file" id="photo-input-only" multiple accept="image/*" class="form-input w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                    </div>

                    <div>
                        <label for="short-text" class="block text-sm font-medium text-[#00FFFF] mb-1">Texto Corto (Opcional)</label>
                        <textarea id="short-text" rows="3" class="form-textarea w-full p-3 rounded-lg text-white" placeholder="Una frase o fecha especial..."></textarea>
                    </div>
                    <div>
                        <label for="long-text" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Historia (Opcional)</label>
                        <textarea id="long-text" rows="5" class="form-textarea w-full p-3 rounded-lg text-white" placeholder="Cuéntanos un poco sobre tu amiguito, sus gustos, alguna anécdota..."></textarea>
                    </div>
                    <div class="flex items-center space-x-3 p-3 bg-yellow-900/20 rounded-lg">
                        <input id="surprise-me-checkbox" type="checkbox" class="h-5 w-5 rounded bg-transparent border-yellow-400 text-yellow-500 focus:ring-yellow-600">
                        <label for="surprise-me-checkbox" class="font-bold text-yellow-300">¡Sorpréndeme!&nbsp;🐾</label>
                    </div>
                    <p id="surprise-me-text" class="text-xs text-yellow-400 hidden">Al marcar esta opción, con mucho respeto, empatía y amor, buscaremos el texto adecuado para tu obra.</p>
                    
                    <div class="flex justify-between items-center pt-4">
                        <button id="back-to-pet-info" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                        <button id="to-summary-section" class="main-button text-white font-bold py-2 px-6 rounded-full flex items-center justify-center">
                            <span id="to-summary-btn-text">Subir y continuar</span>
                            <svg id="to-summary-btn-spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Barra de progreso movida a su nueva ubicación -->
                    <div id="progress-container" class="hidden w-full bg-gray-700 rounded-full h-4 mt-4 relative">
                        <div id="progress-bar" class="bg-gradient-to-r from-green-400 to-cyan-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                        <span id="progress-text" class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white"></span>
                    </div>

                </div>
            </div>
        </section>

        <!-- PASO 5: Resumen y Despacho -->
        <section id="summary-section" class="hidden section-fade-in">
            <div class="max-w-xl mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                <h2 class="text-3xl font-bold text-center mb-6">Revisa tu Pedido</h2>
                <div id="summary-content" class="space-y-4 mb-8 p-4 bg-white/5 rounded-lg">
                    <!-- El resumen del pedido se inyectará aquí -->
                </div>
                <h3 class="text-2xl font-bold text-center mb-4">Información de Despacho</h3>
                <div id="shipping-form" class="space-y-4">
                    <div>
                        <label for="client-name-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Nombre Completo</label>
                        <input type="text" id="client-name-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="Para el registro del pedido">
                    </div>
                    <div>
                        <label for="client-phone-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Tu Teléfono (WhatsApp)</label>
                        <input type="tel" id="client-phone-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="+56 9 1234 5678">
                    </div>
                    <div>
                        <label for="region-select" class="block text-sm font-medium text-[#00FFFF] mb-1">Región</label>
                        <select id="region-select" class="form-select w-full p-3 rounded-lg text-white"></select>
                    </div>
                    <div>
                        <label for="comuna-select" class="block text-sm font-medium text-[#00FFFF] mb-1">Comuna</label>
                        <select id="comuna-select" class="form-select w-full p-3 rounded-lg text-white"></select>
                    </div>
                    <div>
                        <label for="address-input" class="block text-sm font-medium text-[#00FFFF] mb-1">Dirección</label>
                        <input type="text" id="address-input" class="form-input w-full p-3 rounded-lg text-white" placeholder="Calle, número, depto/casa">
                    </div>
                </div>
                <div class="flex justify-between items-center pt-6">
                    <button id="back-to-upload" class="secondary-button font-bold py-2 px-6 rounded-full">Volver</button>
                    <button id="to-payment-section" class="main-button text-white font-bold py-2 px-6 rounded-full flex items-center justify-center">
                        <span id="to-payment-btn-text">Continuar al Pago</span>
                        <svg id="to-payment-btn-spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </section>

        <!-- PASO 6: Pago Y CONFIRMACIÓN FINAL -->
        <section id="payment-section" class="hidden section-fade-in">
            <div class="max-w-xl mx-auto bg-black/20 p-8 rounded-xl border border-white/10 text-center">
                <h2 class="text-3xl font-bold mb-2">Paso Final: Pago Seguro 🔒</h2>
                <p class="text-gray-300 mb-6">Estás a punto de inmortalizar tu recuerdo. Realiza el pago de forma segura a través de Mercado Pago.</p>
                
                <hr class="gradient-divider my-8">

                <!-- Resumen de la Obra -->
                <div id="payment-summary" class="text-left my-6 p-4 bg-white/5 rounded-lg space-y-2">
                    <!-- El resumen se inyectará aquí dinámicamente -->
                </div>

                <div class="my-6">
                    <p class="text-lg text-gray-400 uppercase tracking-wider">Monto Total a Pagar</p>
                    <p id="total-amount" class="text-5xl font-bold text-green-400 my-2"></p>
                </div>

                <div class="my-8 p-6 bg-white/5 rounded-lg max-w-md mx-auto">
                     <img src="https://i.ibb.co/BKnVhZC4/Dise-o-sin-t-tulo-11.png" alt="Paga con Mercado Pago" class="w-72 mx-auto mb-4">
                    
                    <!-- Contenedor para los botones de Mercado Pago -->
                    <div id="payment-buttons-container" class="mt-4 flex justify-center min-h-[50px]">
                        <!-- Botón para Rancagua (119.990) -->
                        <div id="mp-button-rancagua" class="hidden">
                            <script src="https://www.mercadopago.cl/integrations/v1/web-payment-checkout.js"
                            data-preference-id="1380939166-aecc0d0a-9957-4fe5-b9c8-157f0b482c14" data-source="button">
                            </script>
                        </div>
                        <!-- Botón para Aledaños (124.990) -->
                        <div id="mp-button-aledanos" class="hidden">
                            <script src="https://www.mercadopago.cl/integrations/v1/web-payment-checkout.js"
                            data-preference-id="1380939166-a7ab1f73-ac49-4a42-b0ad-380c53e64d90" data-source="button">
                            </script>
                        </div>
                        <!-- Botón para Otras Regiones (127.990) -->
                        <div id="mp-button-regiones" class="hidden">
                            <script src="https://www.mercadopago.cl/integrations/v1/web-payment-checkout.js"
                            data-preference-id="1380939166-e34674ab-a39b-46a8-8d08-9568552f3dba" data-source="button">
                            </script>
                        </div>
                    </div>
                </div>

                <hr class="gradient-divider my-8">

                <div class="mt-8">
                    <button id="back-to-summary" class="secondary-button font-bold py-3 px-8 text-lg rounded-full shadow-lg hover:shadow-xl transition-all duration-300">Volver y revisar</button>
                </div>
            </div>
        </section>

        <!-- PASO 7: PÁGINA DE CONFIRMACIÓN (Gracias) -->
        <section id="thank-you-section" class="hidden section-fade-in text-center">
            <div class="max-w-xl mx-auto bg-black/20 p-8 rounded-xl border border-white/10">
                <h2 class="text-4xl font-bold mb-4">¡Pedido Recibido con Éxito! 🎉</h2>
                <p class="text-lg text-gray-300 mb-6">Hemos confirmado tu pago y tu pedido ya está en nuestras manos. ¡Gracias por confiar en nosotros para inmortalizar tu recuerdo!</p>
                
                <div class="my-8 p-6 bg-white/5 rounded-lg border border-dashed border-gray-500">
                    <p class="text-gray-400 uppercase tracking-wider">Tu Código de Pedido es:</p>
                    <p id="final-order-id" class="text-4xl font-bold text-green-400 my-2 tracking-widest"></p>
                    <p class="text-xs text-gray-500 mt-2">Guarda este código, es tu llave para el seguimiento.</p>
                </div>

                <p class="text-lg text-gray-300 mb-6">El último paso es contactarnos por WhatsApp para afinar los detalles finales de tu obra de arte.</p>
                
                <a id="whatsapp-contact-btn" href="#" target="_blank" class="main-button inline-block text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg hover:shadow-2xl">
                    Contactar por WhatsApp 🐾
                </a>

                <div class="mt-12">
                     <button id="start-new-order-btn" class="secondary-button text-sm font-bold py-2 px-6 rounded-full">Crear un nuevo pedido</button>
                </div>
            </div>
        </section>

    </main>

    <footer id="footer-section" class="text-center py-16 mt-24 border-t border-white/10">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="grid md:grid-cols-2 gap-12 text-center md:text-left">
                <div>
                    <h3 class="text-2xl font-bold mb-4 text-[#00FFFF]">Nuestra Misión 🐾</h3>
                    <p class="text-gray-300">Inmortalizar el amor incondicional entre las mascotas y sus dueños a través de obras de arte únicas y personalizadas, creadas con la más profunda empatía y dedicación para honrar cada huella que dejan en nuestras vidas.</p>
                </div>
                <div>
                    <h3 class="text-2xl font-bold mb-4 text-[#00FFFF]">Nuestra Visión 🐾</h3>
                    <p class="text-gray-300">Ser el referente principal en la creación de homenajes artísticos para mascotas, reconocidos por nuestra capacidad de transformar recuerdos en tesoros eternos que brinden consuelo, alegría y celebren el vínculo sagrado que compartimos con ellos.</p>
                </div>
            </div>
            <div class="mt-12 text-sm text-gray-500">
                <p>&copy; 2025 Las Huellitas de mi Vida. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>
    
    <!-- Botón Flotante de WhatsApp -->
    <a id="whatsapp-float-btn" href="https://wa.me/56946902340?text=Hola%2C%20tengo%20una%20consulta%20sobre%20Las%20Huellitas%20de%20mi%20Vida" target="_blank" class="whatsapp-float-button">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="28" height="28" fill="currentColor">
            <path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/>
        </svg>
    </a>

    <!-- Notificación Toast -->
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-red-500 text-white py-3 px-6 rounded-full shadow-lg text-center z-[100] opacity-0 transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>
    
    <script type="module">
        // --- IMPORTS DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDR42aJIpDkXL5T2vgj-J2ceZFVZCqzCms",
            authDomain: "las-huellitas-de-mi-vida.firebaseapp.com",
            projectId: "las-huellitas-de-mi-vida",
            storageBucket: "las-huellitas-de-mi-vida.firebasestorage.app",
            messagingSenderId: "1095265611249",
            appId: "1:1095265611249:web:09930aaef56d0736bea850",
            measurementId: "G-0QB83X7TBC"
        };

        // Inicialización de los servicios de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // --- ESTADO GLOBAL DE LA APLICACIÓN ---
        const orderState = {
            category: '',
            categoryIcon: '',
            categorySize: '',
            basePrice: 0,
            imageUrls: [],
            petName: '',
            petAge: '',
            clientName: '',
            clientPhone: '',
            orderId: '',
            shortText: '',
            longText: '',
            surpriseMe: false,
            shipping: {
                region: '',
                comuna: '',
                address: '',
                cost: 0,
            },
            firebaseFolderUrl: ''
        };
        
        // --- CONSTANTES ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVyyTWapbUC05wU6oE9tueTqzaHk7xwTTnm_bsHPfHOXoUE0BF3L6CZo8-1iqmN1F3/exec';
        const peekingDog = document.getElementById('peeking-dog');
        const peekingCat = document.getElementById('peeking-cat');
        const peekingFamily = document.getElementById('peeking-family');
        const footerSection = document.getElementById('footer-section');
        
        // --- FUNCIONES UTILITARIAS ---
        
        /**
         * Muestra una sección específica de la página y oculta las demás.
         * @param {string} sectionId - El ID de la sección a mostrar.
         */
        function showSection(sectionId) {
            document.querySelectorAll('main > section').forEach(section => section.classList.add('hidden'));
            document.getElementById(sectionId)?.classList.remove('hidden');
            window.scrollTo(0, 0);

            // Lógica para mostrar/ocultar animales y footer
            const allAnimals = [peekingDog, peekingCat, peekingFamily];
            allAnimals.forEach(animal => {
                animal.classList.add('hidden'); // Ensure all are hidden by default
                animal.classList.remove('hide-mobile-animation'); // Reset animation state
            });
            
            footerSection.classList.toggle('hidden', sectionId !== 'home-section');

            if (sectionId === 'pet-info-section') {
                const isMobile = window.innerWidth < 768;
                let activeAnimal = null;

                if (orderState.category === 'Homenaje a su Vida') {
                    activeAnimal = peekingDog;
                } else if (orderState.category === 'Celebrando la Vida de tu querida mascota.') {
                    activeAnimal = peekingCat;
                } else if (orderState.category === 'Celebrando la Nueva Familia') {
                    activeAnimal = peekingFamily;
                }

                if (activeAnimal) {
                    activeAnimal.classList.remove('hidden'); // Make the correct one visible
                    
                    if (isMobile) {
                        setTimeout(() => {
                            activeAnimal.classList.add('hide-mobile-animation');
                        }, 2500); // After 2.5 seconds, start the animation to hide it
                    }
                }
            }
        }

        /**
         * Muestra una notificación emergente (toast).
         */
        function showNotification(message, isError = true) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-full shadow-lg text-center z-[100] transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.remove('opacity-0'); }, 10);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 500);
            }, 5000);
        }

        /**
         * Genera un ID de pedido único.
         */
        function generateOrderId() {
            const prefix = "HUELLITAS";
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let result = "";
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return `${prefix}-${result}`;
        }

        /**
         * Abre el modal para ver una imagen en grande.
         * @param {string} imageUrl - La URL de la imagen a mostrar.
         */
        function openImageModal(imageUrl) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-img');
            modalImg.src = imageUrl;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        // --- FUNCIONES DE CARGA DE DATOS (FIREBASE) ---

        /**
         * Carga las imágenes de la galería principal desde Firestore.
         */
        async function loadGallery() {
            const grid = document.getElementById("gallery-grid");
            grid.innerHTML = `<p class="text-center col-span-full">Cargando galería...</p>`;
            try {
                const docRef = doc(db, "gallery", "paginaPrincipal");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().imageUrls) {
                    grid.innerHTML = '';
                    docSnap.data().imageUrls.forEach(url => {
                        const div = document.createElement('div');
                        div.className = 'gallery-carousel-item';
                        div.innerHTML = `
                            <div class="rounded-lg overflow-hidden shadow-lg aspect-square">
                                <img src="${url}" alt="Obra de arte" class="w-full h-full object-cover gallery-image-hover cursor-pointer">
                            </div>`;
                        div.querySelector('img').addEventListener('click', () => openImageModal(url));
                        grid.appendChild(div);
                    });
                } else {
                    grid.innerHTML = `<p class="text-yellow-400 text-center col-span-full">No se encontraron imágenes en la galería.</p>`;
                }
            } catch (error) {
                console.error("Error al cargar la galería:", error);
                grid.innerHTML = `<p class="text-red-500 text-center col-span-full">No se pudo cargar la galería.</p>`;
            }
        }
        
        /**
         * Carga las categorías de productos desde Firestore y configura los eventos de click.
         */
        async function loadCategories() {
            const grid = document.getElementById("category-grid");
            grid.innerHTML = `<p class="text-center col-span-full">Cargando proyectos...</p>`;
            try {
                const querySnapshot = await getDocs(collection(db, "categories"));
                if (querySnapshot.empty) {
                    grid.innerHTML = `<p class="text-yellow-400 text-center col-span-full">No hay categorías disponibles.</p>`;
                    return;
                }
                grid.innerHTML = '';
                const categories = [];
                querySnapshot.forEach(doc => categories.push(doc.data()));
                
                categories.sort((a, b) => (a.order || 99) - (b.order || 99));

                categories.forEach(data => {
                    grid.innerHTML += `
                        <div class="category-card rounded-xl cursor-pointer flex flex-col text-center p-4" data-category='${JSON.stringify(data)}'>
                            <div class="flex flex-col flex-grow items-center">
                                <div class="text-6xl mb-4">${data.icon || '🐾'}</div>
                                <h3 class="text-xl font-bold mb-1">${data.name}</h3>
                                <p class="text-gray-400 text-xs mb-2">${data.size}</p>
                                <p class="text-gray-300 text-sm flex-grow">${data.description}</p>
                            </div>
                        </div>`;
                });

                document.querySelectorAll('.category-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const data = JSON.parse(e.currentTarget.dataset.category);
                        orderState.category = data.name;
                        orderState.categoryIcon = data.icon || '🐾';
                        orderState.categorySize = data.size || 'No especificado';
                        orderState.basePrice = Number(data.price || 119990);
                        orderState.imageUrls = data.imageUrls || [];
                        
                        const preview = document.getElementById('product-image-preview');
                        const thumbs = document.getElementById('thumbnail-container');
                        thumbs.innerHTML = '';
                        
                        if (orderState.imageUrls.length > 0) {
                            preview.src = orderState.imageUrls[0];
                            orderState.imageUrls.forEach((url, index) => {
                                const thumb = document.createElement('img');
                                thumb.src = url;
                                thumb.className = 'thumbnail-image' + (index === 0 ? ' active' : '');
                                thumb.onclick = () => {
                                    preview.src = url;
                                    document.querySelectorAll('.thumbnail-image').forEach(t => t.classList.remove('active'));
                                    thumb.classList.add('active');
                                };
                                thumbs.appendChild(thumb);
                            });
                        } else {
                            preview.src = 'https://placehold.co/400x300/333/FFF?text=Sin+Imagen';
                        }
                        
                        document.getElementById('pet-info-title').textContent = `Proyecto: ${orderState.category}`;
                        
                        // --- LÓGICA DE DISEÑO Y TEXTO CONDICIONAL ---
                        const layoutContainer = document.getElementById('pet-info-layout-container');
                        const formContainer = document.getElementById('pet-form-container');
                        const descriptionContainer = document.getElementById('pet-description-container');
                        
                        // Resetea clases de layout, orden y márgenes
                        layoutContainer.classList.remove('md:ml-64', 'md:mr-64');
                        formContainer.classList.remove('md:order-1', 'md:order-2');
                        descriptionContainer.classList.remove('md:order-1', 'md:order-2');
                        
                        let descriptionHTML = '';

                        if (orderState.category === 'Celebrando la Vida de tu querida mascota.') {
                            // Mascota a la DERECHA -> Contenido a la IZQUIERDA
                            formContainer.classList.add('md:order-2');
                            descriptionContainer.classList.add('md:order-1');
                            layoutContainer.classList.add('md:mr-64'); // Margen derecho para no chocar con la mascota
                            
                            descriptionHTML = `
                                <h3 class="text-3xl md:text-4xl font-bold text-[#00FFFF] mb-4">Celebrando su Mágica Presencia</h3>
                                <p class="text-gray-300">
                                    Tu compañero, sea cual sea su especie, es una fuente de alegría infinita. Esta obra es un tributo vibrante a su singular presencia y a esos instantes de calma y travesuras que llenan tu hogar de vida.
                                </p>
                                <p class="text-gray-300 mt-4">
                                    A partir de tus fotografías, nuestros artistas crearán un retrato conmovedor que captura la esencia única de tu amigo. Cada trazo es una celebración de su espíritu, realizado con una delicada mezcla de <strong>lápices pastel seco, acuarelas y acrílicos</strong>. La obra final, protegida con barnices y un bello <strong>vidrio opaco</strong>, se presenta en un elegante <strong>marco en tonos crema</strong> para convertirse en una pieza de arte atemporal que inmortaliza el espíritu libre de tu querido compañero.
                                </p>
                            `;
                        } else {
                            // Mascota a la IZQUIERDA -> Contenido a la DERECHA (por defecto para las otras dos)
                            formContainer.classList.add('md:order-1');
                            descriptionContainer.classList.add('md:order-2');
                            layoutContainer.classList.add('md:ml-64'); // Margen izquierdo para no chocar
                            
                            if (orderState.category === 'Homenaje a su Vida') {
                                descriptionHTML = `
                                    <h3 class="text-3xl md:text-4xl font-bold text-[#00FFFF] mb-4">Un Homenaje a su Huella Inolvidable</h3>
                                    <p class="text-gray-300">
                                        Cada momento que tu amigo dejó en tu vida es un tesoro. Con profundo respeto y amor, transformamos esos recuerdos en un homenaje eterno. A partir de tus fotografías más queridas, nuestros artistas crearán un dibujo conmovedor que captura la esencia única de tu mascota.
                                    </p>
                                    <p class="text-gray-300 mt-4">
                                        Cada trazo es una celebración de su espíritu, realizado con una delicada mezcla de <strong>lápices pastel seco, acuarelas y acrílicos</strong>. La obra final, protegida con barnices y un bello <strong>vidrio opaco</strong>, se presenta en un elegante <strong>marco en tonos crema</strong> para convertirse en una pieza de arte atemporal que honra su paso por tu familia.
                                    </p>
                                `;
                            } else { // Celebrando la Nueva Familia
                                descriptionHTML = `
                                    <h3 class="text-3xl md:text-4xl font-bold text-[#00FFFF] mb-4">El Retrato de la Manada Feliz</h3>
                                    <p class="text-gray-300">
                                        ¿Uno no era suficiente? ¡Celebremos el caos y el amor de tu familia multiespecie! Esta obra es un tributo a la dinámica única de tu manada, capturando las personalidades y la conexión especial que comparten.
                                    </p>
                                    <p class="text-gray-300 mt-4">
                                        Con tus fotos como inspiración, crearemos una composición artística que refleje la armonía de tu hogar. Usando una técnica mixta de <strong>lápices pastel, acuarelas y acrílicos</strong>, cada detalle es cuidadosamente trabajado. La pieza final, protegida con barnices y un bello <strong>vidrio opaco</strong>, se presenta en un elegante <strong>marco en tonos crema</strong> que la convierte en un tesoro familiar para celebrar la alegría de estar juntos.
                                    </p>
                                `;
                            }
                        }
                        descriptionContainer.innerHTML = descriptionHTML;
                        
                        showSection('pet-info-section');
                    });
                });

            } catch (error) {
                console.error("Error al cargar categorías:", error);
                grid.innerHTML = `<p class="text-red-500 text-center col-span-full">No se pudo cargar el contenido.</p>`;
            }
        }

        // --- LÓGICA DE NEGOCIO Y SUBIDA DE ARCHIVOS ---

        /**
         * Renderiza el resumen del producto en la página de pago.
         */
        function renderPaymentSummary() {
            const summaryContainer = document.getElementById('payment-summary');
            const summaryText = "Terminaciones en vidrio opaco, fotografías impresas en papel fotográfico premium mate, lápices pastel seco, acrílicos, acuarelas, rotuladores de tinta, fijadores y barnices.";
            
            summaryContainer.innerHTML = `
                <h4 class="text-xl font-bold text-center mb-4 text-[#00FFFF]">Detalles de tu Obra</h4>
                <p><strong>Proyecto:</strong> ${orderState.categoryIcon} ${orderState.category}</p>
                <p><strong>Tamaño:</strong> ${orderState.categorySize}</p>
                <p><strong>Resumen:</strong> ${summaryText}</p>
            `;
        }

        /**
         * Sube los archivos seleccionados por el usuario a Firebase Storage.
         */
        async function uploadFilesToFirebase(orderId) {
            const photoInput = orderState.hasVideo ? document.getElementById('photo-input-multi') : document.getElementById('photo-input-only');
            const videoInput = orderState.hasVideo ? document.getElementById('video-input-multi') : null;

            let filesToUpload = [...photoInput.files];
            if (videoInput && videoInput.files.length > 0) {
                filesToUpload.push(...videoInput.files);
            }
            
            const textContent = `ID Pedido: ${orderState.orderId}\nNombre Mascota: ${orderState.petName}\n\nTexto Corto:\n${orderState.shortText}\n\nHistoria:\n${orderState.longText}`;
            if (!orderState.surpriseMe && (orderState.shortText || orderState.longText)) {
                const textBlob = new Blob([textContent], { type: 'text/plain' });
                const textFile = new File([textBlob], "datos_cliente.txt", {type: "text/plain"});
                filesToUpload.push(textFile);
            }
            
            const totalSize = filesToUpload.reduce((acc, file) => acc + file.size, 0);
            const individualProgress = {};
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('progress-container');
            const progressText = document.getElementById('progress-text');
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = '0%';

            const uploadPromises = filesToUpload.map(file => {
                return new Promise((resolve, reject) => {
                    const fileRef = ref(storage, `pedidos/${orderId}/${file.name}`);
                    const uploadTask = uploadBytesResumable(fileRef, file);

                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            individualProgress[file.name] = snapshot.bytesTransferred;
                            let totalBytesUploaded = Object.values(individualProgress).reduce((a, b) => a + b, 0);
                            const progress = totalSize > 0 ? Math.round((totalBytesUploaded / totalSize) * 100) : 0;
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `${progress}%`;
                        }, 
                        (error) => {
                            console.error("Fallo la subida para:", file.name, error);
                            reject(error);
                        }, 
                        () => {
                            individualProgress[file.name] = file.size;
                            let totalBytesUploaded = Object.values(individualProgress).reduce((a, b) => a + b, 0);
                            const progress = totalSize > 0 ? Math.round((totalBytesUploaded / totalSize) * 100) : 0;
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `${progress}%`;
                            resolve();
                        }
                    );
                });
            });

            await Promise.all(uploadPromises);
            console.log("--- SUBIDA COMPLETADA ---");
        }

        /**
         * Envía los datos del pedido a un script de Google Sheets.
         */
        async function sendOrderToGoogleSheet() {
             if (GOOGLE_SCRIPT_URL === 'PEGA_AQUI_TU_NUEVA_URL_DEL_SCRIPT' || !GOOGLE_SCRIPT_URL) {
                throw new Error("La URL del script de Google no ha sido configurada.");
             }
            const formData = new FormData();
            formData.append('timestamp', new Date().toLocaleString("es-CL"));
            formData.append('orderId', orderState.orderId);
            formData.append('category', orderState.category);
            formData.append('petName', orderState.petName);
            formData.append('petAge', orderState.petAge);
            formData.append('clientName', orderState.clientName || '');
            formData.append('address', `${orderState.shipping.address}, ${orderState.shipping.comuna}, ${orderState.shipping.region}`);
            formData.append('phone', orderState.clientPhone || '');
            formData.append('shippingCost', orderState.shipping.cost);
            formData.append('totalPaid', orderState.basePrice + orderState.shipping.cost);
            formData.append('shortText', orderState.surpriseMe ? '¡Sorpréndeme!' : orderState.shortText);
            formData.append('longText', orderState.surpriseMe ? '¡Sorpréndeme!' : orderState.longText);
            formData.append('filesLink', orderState.firebaseFolderUrl);
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: formData,
                });
                console.log("Datos enviados a Google Sheets.");
            } catch (error) {
                console.error("Error al enviar datos a Google Sheets:", error);
                // No lanzamos un error al usuario, pero lo registramos.
                // La app puede continuar aunque el registro en Sheets falle.
            }
        }

        // --- INICIALIZACIÓN DE LA APLICACIÓN ---
        document.addEventListener('DOMContentLoaded', async () => {
            // --- DETECCIÓN DE REDIRECCIÓN DE MERCADO PAGO ---
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('status');

            if (paymentStatus === 'approved') {
                const savedStateJSON = sessionStorage.getItem('huellitasOrderState');
                if (savedStateJSON) {
                    const savedState = JSON.parse(savedStateJSON);
                    
                    document.getElementById('final-order-id').textContent = savedState.orderId;
                    const WHATSAPP_NUMBER = '56946902340'; // Reemplazar con tu número
                    const message = `¡Hola! 👋 Acabo de realizar mi pedido a través de la web. Mi código de seguimiento es: *${savedState.orderId}*`;
                    document.getElementById('whatsapp-contact-btn').href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;

                    showSection('thank-you-section');
                    
                    sessionStorage.removeItem('huellitasOrderState');
                    window.history.replaceState({}, document.title, window.location.pathname); 

                    return;
                }
            }
            
            const locations = { "Arica y Parinacota": ["Arica", "Camarones", "Putre", "General Lagos"], "Tarapacá": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Camiña", "Colchane", "Huara", "Pica"], "Antofagasta": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollagüe", "San Pedro de Atacama", "Tocopilla", "María Elena"], "Atacama": ["Copiapó", "Caldera", "Tierra Amarilla", "Chañaral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"], "Coquimbo": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicuña", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbalá", "Monte Patria", "Punitaqui", "Río Hurtado"], "Valparaíso": ["Valparaíso", "Casablanca", "Concón", "Juan Fernández", "Puchuncaví", "Quintero", "Viña del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa María", "Quilpué", "Limache", "Olmué", "Villa Alemana"], "Metropolitana de Santiago": ["Santiago", "Cerrillos", "Cerro Navia", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maipú", "Ñuñoa", "Pedro Aguirre Cerda", "Peñalolén", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "San Joaquín", "San Miguel", "San Ramón", "Vitacura", "Puente Alto", "Pirque", "San José de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhué", "Curacaví", "María Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Peñaflor"], "O'Higgins": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Doñihue", "Graneros", "Las Cabras", "Machalí", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requínoa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Chépica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"], "Maule": ["Talca", "Constitución", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "Río Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curicó", "Hualañé", "Licantén", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuquén", "Linares", "Colbún", "Longaví", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"], "Ñuble": ["Chillán", "Bulnes", "Chillán Viejo", "El Carmen", "Pemuco", "Pinto", "Quillón", "San Ignacio", "Yungay", "Quirihue", "Cobquecura", "Coelemu", "Ninhue", "Portezuelo", "Ránquil", "Treguaco", "San Carlos", "Coihueco", "Ñiquén", "San Fabián", "San Nicolás"], "Biobío": ["Concepción", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tomé", "Hualpén", "Lebu", "Arauco", "Cañete", "Contulmo", "Curanilahue", "Los Álamos", "Tirúa", "Los Ángeles", "Antuco", "Cabrero", "Laja", "Mulchén", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa Bárbara", "Tucapel", "Yumbel", "Alto Biobío"], "Araucanía": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre las Casas", "Perquenco", "Pitrufquén", "Pucón", "Saavedra", "Teodoro Schmidt", "Toltén", "Vilcún", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacautín", "Ercilla", "Lonquay", "Los Sauces", "Lumaco", "Purén", "Renaico", "Traiguén", "Victoria"], "Los Ríos": ["Valdivia", "Corral", "Lanco", "Los Lagos", "Máfil", "Mariquina", "Paillaco", "Panguipulli", "La Unión", "Futrono", "Lago Ranco", "Río Bueno"], "Los Lagos": ["Puerto Montt", "Calbuco", "Cochamó", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maullín", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de Vélez", "Dalcahue", "Puqueldón", "Queilén", "Quellón", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "Río Negro", "San Juan de la Costa", "San Pablo", "Chaitén", "Futaleufú", "Hualaihué", "Palena"], "Aysén": ["Coyhaique", "Lago Verde", "Aysén", "Cisnes", "Guaitecas", "Cochrane", "O'Higgins", "Tortel", "Chile Chico", "Río Ibáñez"], "Magallanes": ["Punta Arenas", "Laguna Blanca", "Río Verde", "San Gregorio", "Cabo de Hornos (Ex Navarino)", "Antártica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"] };
            const regionSelect = document.getElementById('region-select');
            const comunaSelect = document.getElementById('comuna-select');
            
            function populateRegions() {
                regionSelect.innerHTML = '<option value="">Selecciona una Región</option>';
                Object.keys(locations).sort().forEach(region => regionSelect.add(new Option(region, region)));
            }
            regionSelect.addEventListener('change', () => {
                comunaSelect.innerHTML = '<option value="">Selecciona una Comuna</option>';
                const comunas = locations[regionSelect.value] || [];
                comunas.sort().forEach(comuna => comunaSelect.add(new Option(comuna, comuna)));
            });

            function renderSummary() {
                document.getElementById('summary-content').innerHTML = `
                    <p><strong>Categoría:</strong> ${orderState.category}</p>
                    <p><strong>Mascota:</strong> ${orderState.petName}, ${orderState.petAge} años</p>
                    <p><strong>ID de Pedido:</strong> ${orderState.orderId}</p>
                    <p><strong>Textos:</strong> ${orderState.surpriseMe ? '¡Sorpréndeme! Equipo elegirá los textos.' : 'Personalizados.'}</p>
                    <p class="text-green-400"><strong>Archivos:</strong> Recibidos correctamente ✔️</p>
                `;
            }

            function showPaymentDetails() {
                const buttons = {
                    rancagua: document.getElementById('mp-button-rancagua'),
                    aledanos: document.getElementById('mp-button-aledanos'),
                    regiones: document.getElementById('mp-button-regiones')
                };
                Object.values(buttons).forEach(btn => btn.classList.add('hidden'));

                const comuna = orderState.shipping.comuna;
                const comunasAledanas = ['Machalí', 'Graneros', 'Olivar', 'Doñihue', 'Requínoa', 'Codegua', 'Mostazal', 'Coinco', 'Coltauco', 'Rengo'];
                
                let targetButton = buttons.regiones;
                orderState.shipping.cost = 8000;
                if (comuna === 'Rancagua') {
                    targetButton = buttons.rancagua;
                    orderState.shipping.cost = 0;
                } else if (comunasAledanas.includes(comuna)) {
                    targetButton = buttons.aledanos;
                    orderState.shipping.cost = 5000;
                }
                
                document.getElementById('total-amount').textContent = `$${(orderState.basePrice + orderState.shipping.cost).toLocaleString('es-CL')}`;
                
                if (targetButton) {
                    targetButton.classList.remove('hidden');
                }
            }

            // --- MANEJADORES DE EVENTOS (EVENT LISTENERS) ---
            document.getElementById('start-project-btn').addEventListener('click', () => showSection('category-section'));
            document.getElementById('back-to-category').addEventListener('click', () => showSection('category-section'));
            
            document.getElementById('to-upload-section').addEventListener('click', () => {
                const petName = document.getElementById('pet-name').value.trim();
                const petAge = document.getElementById('pet-age').value.trim();
                if (!petName || !petAge) {
                    showNotification('Por favor, completa nombre y edad.');
                    return;
                }
                orderState.petName = petName;
                orderState.petAge = petAge;
                orderState.orderId = generateOrderId();
                showSection('upload-section');
            });

            document.getElementById('back-to-pet-info').addEventListener('click', () => showSection('pet-info-section'));
            document.getElementById('has-video-btn').addEventListener('click', () => {
                orderState.hasVideo = true;
                document.getElementById('video-choice-container').classList.add('hidden');
                document.getElementById('file-inputs-container').classList.remove('hidden');
                document.getElementById('photos-and-video-upload').classList.remove('hidden');
                document.getElementById('photos-only-upload').classList.add('hidden');
            });
            document.getElementById('no-video-btn').addEventListener('click', () => {
                orderState.hasVideo = false;
                document.getElementById('video-choice-container').classList.add('hidden');
                document.getElementById('file-inputs-container').classList.remove('hidden');
                document.getElementById('photos-only-upload').classList.remove('hidden');
                document.getElementById('photos-and-video-upload').classList.add('hidden');
            });

            const surpriseCheckbox = document.getElementById('surprise-me-checkbox');
            const shortTextArea = document.getElementById('short-text');
            const longTextArea = document.getElementById('long-text');
            surpriseCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                orderState.surpriseMe = isChecked;
                document.getElementById('surprise-me-text').classList.toggle('hidden', !isChecked);
                shortTextArea.disabled = isChecked;
                longTextArea.disabled = isChecked;
                if (isChecked) {
                    shortTextArea.value = '';
                    longTextArea.value = '';
                }
            });

            document.getElementById('to-summary-section').addEventListener('click', async (e) => {
                const button = e.currentTarget;
                const buttonText = document.getElementById('to-summary-btn-text');
                const spinner = document.getElementById('to-summary-btn-spinner');
                const photoInput = orderState.hasVideo ? document.getElementById('photo-input-multi') : document.getElementById('photo-input-only');
                if (photoInput.files.length === 0) {
                    showNotification('Por favor, selecciona al menos una foto.');
                    return;
                }
                
                button.disabled = true;
                spinner.classList.remove('hidden');
                buttonText.textContent = 'Subiendo...';

                try {
                    orderState.shortText = shortTextArea.value.trim();
                    orderState.longText = longTextArea.value.trim();
                    orderState.surpriseMe = surpriseCheckbox.checked;

                    await uploadFilesToFirebase(orderState.orderId);
                    
                    orderState.firebaseFolderUrl = `https://console.firebase.google.com/project/${firebaseConfig.projectId}/storage/${firebaseConfig.storageBucket}/files~2Fpedidos~2F${orderState.orderId}`;
                    
                    showNotification("Archivos subidos con éxito", false);
                    renderSummary();
                    showSection('summary-section');
                } catch (error) {
                    console.error("Error definitivo en la subida:", error);
                    showNotification("Un error impidió subir los archivos. Por favor, inténtalo de nuevo.");
                } finally {
                    button.disabled = false;
                    buttonText.textContent = 'Subir y continuar';
                    spinner.classList.add('hidden');
                    document.getElementById('progress-container').classList.add('hidden');
                    document.getElementById('progress-bar').style.width = '0%';
                    document.getElementById('progress-text').textContent = '';
                }
            });

            document.getElementById('back-to-upload').addEventListener('click', () => showSection('upload-section'));
            
            document.getElementById('to-payment-section').addEventListener('click', async (e) => {
                const button = e.currentTarget;
                const buttonText = document.getElementById('to-payment-btn-text');
                const spinner = document.getElementById('to-payment-btn-spinner');

                const clientName = document.getElementById('client-name-input').value.trim();
                const clientPhone = document.getElementById('client-phone-input').value.trim();
                const region = document.getElementById('region-select').value;
                const comuna = document.getElementById('comuna-select').value;
                const address = document.getElementById('address-input').value.trim();

                if (!clientName || !clientPhone || !region || !comuna || !address) {
                    showNotification('Por favor, completa todos los campos de despacho.');
                    return;
                }
                
                button.disabled = true;
                spinner.classList.remove('hidden');
                buttonText.textContent = 'Registrando...';

                orderState.clientName = clientName;
                orderState.clientPhone = clientPhone;
                orderState.shipping.region = region;
                orderState.shipping.comuna = comuna;
                orderState.shipping.address = address;

                try {
                    sessionStorage.setItem('huellitasOrderState', JSON.stringify(orderState));
                    
                    await sendOrderToGoogleSheet();
                    
                    renderPaymentSummary(); 
                    showPaymentDetails();
                    showSection('payment-section');
                } catch (error) {
                    console.error("Error al registrar el pedido en Google Sheets:", error);
                    showNotification(`No se pudo registrar tu pedido. Revisa tu conexión.`);
                } finally {
                    button.disabled = false;
                    spinner.classList.add('hidden');
                    buttonText.textContent = 'Continuar al Pago';
                }
            });

            document.getElementById('back-to-summary').addEventListener('click', () => showSection('summary-section'));
            
            // Lógica del Modal para ampliar imágenes
            const modal = document.getElementById('image-modal');
            const closeModalBtn = document.getElementById('close-modal');

            document.getElementById('product-image-preview').addEventListener('click', (e) => {
                openImageModal(e.target.src);
            });

            const closeModal = () => {
                modal.querySelector('.modal-content').classList.add('scale-95');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // Lógica del carrusel de la galería principal
            const galleryGrid = document.getElementById('gallery-grid');
            const prevBtn = document.getElementById('gallery-prev');
            const nextBtn = document.getElementById('gallery-next');

            const scrollGallery = (direction) => {
                const scrollAmount = galleryGrid.clientWidth * 0.75; // Desplaza el 75% del ancho visible
                galleryGrid.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
            };
            prevBtn.addEventListener('click', () => scrollGallery(-1));
            nextBtn.addEventListener('click', () => scrollGallery(1));

            // Botón para reiniciar el flujo desde la página de gracias.
            document.getElementById('start-new-order-btn').addEventListener('click', () => {
                window.location.href = window.location.pathname; 
            });
            
            // --- INICIALIZACIÓN ---
            populateRegions();
            await loadGallery();
            await loadCategories();
            showSection('home-section');
        });

    </script>
</body>
</html>


